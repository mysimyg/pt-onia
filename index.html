<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Time Off Optimizer</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="apple-mobile-web-app-title" content="PTO">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --accent-highlight: #dc2626;
            --bg-primary: #ffffff;
            --bg-secondary: #f7f7f7;
            --bg-tertiary: #eeeeee;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.08);
            --color-holiday: #22c55e;
            --color-nine80: #3b82f6;
            --color-pto: #ec4899;
            --color-activism: #8b5cf6;
            --color-personal: #f59e0b;
            --color-wellness: #14b8a6;
            --color-weekend: #d1d5db;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }

        [data-theme="light-default"] {
            --accent-primary: #2563eb; --accent-secondary: #7c3aed; --accent-highlight: #dc2626;
            --bg-primary: #ffffff; --bg-secondary: #f7f7f7; --bg-tertiary: #eeeeee;
            --text-primary: #1a1a1a; --text-secondary: #666666; --text-muted: #999999;
            --border-color: #e0e0e0;
            --color-holiday: #22c55e; --color-nine80: #3b82f6; --color-pto: #ec4899;
            --color-activism: #8b5cf6; --color-personal: #f59e0b; --color-wellness: #14b8a6;
            --color-weekend: #d1d5db;
        }

        [data-theme="light-minimal"] {
            --accent-primary: #666666; --accent-secondary: #888888; --accent-highlight: #333333;
            --bg-primary: #fafafa; --bg-secondary: #f5f5f5; --bg-tertiary: #ebebeb;
            --text-primary: #333333; --text-secondary: #666666; --text-muted: #999999;
            --border-color: #e5e5e5;
            --color-holiday: #6b9080; --color-nine80: #7d8597; --color-pto: #a5a58d;
            --color-activism: #b7b7a4; --color-personal: #ddbea9; --color-wellness: #9db4c0;
            --color-weekend: #e0e0e0;
        }

        [data-theme="light-coastal"] {
            --accent-primary: #0077b6; --accent-secondary: #00a8e8; --accent-highlight: #ff6b6b;
            --bg-primary: #f8fbfc; --bg-secondary: #e8f4f8; --bg-tertiary: #d6eaf2;
            --text-primary: #1b4965; --text-secondary: #457b9d; --text-muted: #7da3b7;
            --border-color: #bee3f0;
            --color-holiday: #52b788; --color-nine80: #4895ef; --color-pto: #f77f92;
            --color-activism: #9d80cb; --color-personal: #f9c74f; --color-wellness: #43aa8b;
            --color-weekend: #cce3de;
        }

        [data-theme="light-bold"] {
            --accent-primary: #e63946; --accent-secondary: #ff006e; --accent-highlight: #fb5607;
            --bg-primary: #ffffff; --bg-secondary: #fff5f5; --bg-tertiary: #ffe8e8;
            --text-primary: #2b2d42; --text-secondary: #555b6e; --text-muted: #8d93a5;
            --border-color: #ebd5d5;
            --color-holiday: #06d6a0; --color-nine80: #4361ee; --color-pto: #ff006e;
            --color-activism: #8338ec; --color-personal: #ffbe0b; --color-wellness: #3a86a8;
            --color-weekend: #e8e8e8;
        }

        [data-theme="dark-default"] {
            --accent-primary: #60a5fa; --accent-secondary: #a78bfa; --accent-highlight: #f87171;
            --bg-primary: #121212; --bg-secondary: #1e1e1e; --bg-tertiary: #2a2a2a;
            --text-primary: #f5f5f5; --text-secondary: #b0b0b0; --text-muted: #808080;
            --border-color: #333333;
            --color-holiday: #4ade80; --color-nine80: #60a5fa; --color-pto: #f472b6;
            --color-activism: #a78bfa; --color-personal: #fbbf24; --color-wellness: #2dd4bf;
            --color-weekend: #404040;
        }

        [data-theme="dark-minimal"] {
            --accent-primary: #a8a29e; --accent-secondary: #d6d3d1; --accent-highlight: #78716c;
            --bg-primary: #1c1917; --bg-secondary: #292524; --bg-tertiary: #3a3432;
            --text-primary: #e7e5e4; --text-secondary: #a8a29e; --text-muted: #78716c;
            --border-color: #44403c;
            --color-holiday: #84a98c; --color-nine80: #8a9a9e; --color-pto: #c9ada7;
            --color-activism: #a5a58d; --color-personal: #d4a574; --color-wellness: #7eb09b;
            --color-weekend: #3a3a3a;
        }

        [data-theme="dark-coastal"] {
            --accent-primary: #38bdf8; --accent-secondary: #22d3ee; --accent-highlight: #fb7185;
            --bg-primary: #0c1821; --bg-secondary: #132632; --bg-tertiary: #1b3847;
            --text-primary: #e0f2fe; --text-secondary: #7dd3fc; --text-muted: #5891a8;
            --border-color: #1e4052;
            --color-holiday: #34d399; --color-nine80: #38bdf8; --color-pto: #fb7185;
            --color-activism: #c084fc; --color-personal: #fcd34d; --color-wellness: #2dd4bf;
            --color-weekend: #1a2f3d;
        }

        [data-theme="dark-bold"] {
            --accent-primary: #ff3366; --accent-secondary: #ff00ff; --accent-highlight: #ff6600;
            --bg-primary: #0a0a0f; --bg-secondary: #15151e; --bg-tertiary: #1f1f2e;
            --text-primary: #ffffff; --text-secondary: #c0c0d0; --text-muted: #8080a0;
            --border-color: #2a2a40;
            --color-holiday: #00ff88; --color-nine80: #00aaff; --color-pto: #ff3399;
            --color-activism: #aa55ff; --color-personal: #ffcc00; --color-wellness: #00ddcc;
            --color-weekend: #1a1a2e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-select {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
        }

        .save-btn {
            padding: 8px 12px;
            background: var(--accent-primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .save-btn:active { transform: scale(0.98); }

        /* Desktop: unit toggle stays inline in header-controls, hide row-2 wrapper */
        .header-row-2 { display: none; }
        .header-controls .unit-toggle-desktop { display: flex; }

        /* Mobile Header — 2-row layout */
        @media (max-width: 900px) {
            .header {
                flex-wrap: wrap;
                padding: 10px 12px 8px;
                gap: 8px;
            }
            .header h1 {
                font-size: 16px;
                flex: 1;
                min-width: 0;
            }
            .header-controls {
                gap: 6px;
                order: 0;
            }
            .header-controls .unit-toggle-desktop { display: none; }
            .header-row-2 {
                display: flex;
                align-items: center;
                gap: 8px;
                width: 100%;
                order: 3;
            }
            .theme-select {
                min-height: 36px;
                padding: 6px 8px;
                font-size: 12px;
            }
            .save-btn {
                min-height: 36px;
                padding: 8px 14px;
                font-size: 13px;
            }
            .header-row-2 .unit-toggle {
                flex: 1;
            }
            .header-row-2 .unit-btn {
                flex: 1;
                min-height: 36px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Desktop Layout */
        .desktop-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            min-height: calc(100vh - 53px);
        }

        @media (max-width: 900px) {
            .desktop-layout { display: none; }
        }

        /* Mobile Layout */
        .mobile-layout {
            display: none;
            flex-direction: column;
            min-height: calc(100vh - 53px);
            padding-bottom: 60px;
        }

        @media (max-width: 900px) {
            .mobile-layout { display: flex; }
        }

        /* Sidebar (Desktop) */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 53px);
            position: sticky;
            top: 53px;
        }

        .section { margin-bottom: 20px; }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        /* Type Selector */
        .type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .type-btn {
            padding: 10px 4px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #000;
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: inherit;
        }
        .type-btn .type-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            display: block;
        }

        .type-btn.pto { background: var(--color-pto); }
        .type-btn.activism { background: var(--color-activism); }
        .type-btn.personal { background: var(--color-personal); }
        .type-btn.wellness { background: var(--color-wellness); }
        .type-btn.active { border-color: var(--text-primary); transform: scale(1.02); }
        .type-btn .avail { display: block; font-size: 9px; font-weight: 500; opacity: 0.8; margin-top: 2px; }

        /* Form Elements */
        .input-group { margin-bottom: 10px; }
        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .input-group input[readonly] {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .input-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .input-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        .custom-pto-fields { display: none; margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; }
        .custom-pto-fields.visible { display: block; }

        /* Collapsible - styles defined in feature section below */

        /* Holiday List */
        .holiday-list { display: flex; flex-direction: column; gap: 2px; max-height: 180px; overflow-y: auto; }
        .holiday-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .holiday-item:hover { background: var(--bg-tertiary); }
        .holiday-item input { accent-color: var(--accent-primary); }

        /* Stats */
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .stat-card.success { border-left: 3px solid var(--color-success); }
        .stat-card.warning { border-left: 3px solid var(--color-warning); }
        .stat-card.danger { border-left: 3px solid var(--color-danger); }
        .stat-label { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
        .stat-value { font-size: 22px; font-weight: 600; margin: 2px 0; }
        .stat-detail { font-size: 11px; color: var(--text-secondary); }

        .balance-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .balance-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid;
        }
        .balance-card.pto { border-left-color: var(--color-pto); }
        .balance-card.activism { border-left-color: var(--color-activism); }
        .balance-card.personal { border-left-color: var(--color-personal); }
        .balance-card.wellness { border-left-color: var(--color-wellness); }
        .balance-card .label { font-size: 9px; font-weight: 500; text-transform: uppercase; color: var(--text-muted); }
        .balance-card .value { font-size: 16px; font-weight: 600; margin: 2px 0; }
        .balance-card .detail { font-size: 9px; color: var(--text-secondary); }

        /* Quick Select */
        .quick-section { margin-bottom: 12px; }
        .quick-section-title { font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .quick-actions { display: flex; flex-wrap: wrap; gap: 4px; }
        .quick-btn {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 500;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }
        .quick-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .quick-btn.accent { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
        .quick-btn.accent:hover { background: var(--accent-secondary); border-color: var(--accent-secondary); }
        .quick-btn.clear { border-color: var(--color-danger); color: var(--color-danger); }
        .quick-btn.disabled { opacity: 0.4; cursor: default; }

        /* Opportunities */
        .opportunity-list { display: flex; flex-direction: column; gap: 6px; max-height: 250px; overflow-y: auto; }
        .opp-group-header { font-size: 9px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin: 10px 0 4px; }
        .opportunity-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
        }
        .opportunity-item:hover { border-color: var(--accent-primary); }
        .opportunity-item.selected { border-color: var(--color-pto); background: rgba(236, 72, 153, 0.05); }
        .opportunity-item .title { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .opportunity-item .details { font-size: 10px; color: var(--text-secondary); }
        .opportunity-item .badges { display: flex; gap: 4px; margin-top: 6px; }
        .badge { font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 3px; }
        .badge-hours { background: var(--accent-highlight); color: #fff; }
        .badge-days { background: var(--color-success); color: #fff; }

        /* Content Area */
        .content-area { padding: 16px; overflow-y: auto; }

        /* Charts */
        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .chart-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .projection-chart { height: 80px; position: relative; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; }
        .chart-bar { position: absolute; bottom: 0; background: var(--color-success); border-radius: 2px 2px 0 0; }
        .chart-bar.warning { background: var(--color-warning); }
        .chart-bar.danger { background: var(--color-danger); }
        .chart-max-line { position: absolute; left: 0; right: 0; border-top: 2px dashed var(--color-danger); opacity: 0.6; }
        .chart-data-table { margin-top: 12px; overflow-x: auto; font-size: 10px; }
        .chart-data-table table { width: 100%; border-collapse: collapse; min-width: 400px; }
        .chart-data-table th, .chart-data-table td { padding: 4px 6px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .chart-data-table th { font-weight: 500; color: var(--text-muted); text-align: left; background: var(--bg-tertiary); position: sticky; left: 0; }
        .chart-data-table tr.pto-row td { color: var(--color-pto); font-weight: 600; }
        .chart-data-table tr.wellness-row td { color: var(--color-wellness); font-weight: 600; }
        .chart-data-table tr.activism-row td { color: var(--color-activism); font-weight: 600; }
        .chart-data-table tr.personal-row td { color: var(--color-personal); font-weight: 600; }
        .chart-data-table td.warning { color: var(--color-warning) !important; }
        .chart-data-table td.danger { color: var(--color-danger) !important; }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-secondary); }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        .legend-color.split { background: linear-gradient(135deg, var(--color-holiday) 50%, var(--color-nine80) 50%); }

        /* Calendar Grid */
        .calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .month-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }

        .month-title { font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 8px; }
        .weekday-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; margin-bottom: 2px; }
        .weekday-header span { text-align: center; font-size: 9px; font-weight: 600; color: var(--text-muted); padding: 2px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            border-radius: 4px;
            background: var(--bg-primary);
            position: relative;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
        }

        .day:hover:not(.empty):not(.weekend):not(.holiday):not(.nine80):not(.holiday-nine80) {
            border-color: var(--accent-primary);
            transform: scale(1.05);
            z-index: 5;
        }

        .day.empty { background: transparent; cursor: default; }
        .day.weekend { background: var(--color-weekend); color: var(--text-muted); cursor: default; }
        .day.holiday { background: var(--color-holiday); color: #fff; font-weight: 600; cursor: default; }
        .day.nine80 { background: var(--color-nine80); color: #fff; font-weight: 600; cursor: default; }
        .day.holiday-nine80 { background: linear-gradient(135deg, var(--color-holiday) 50%, var(--color-nine80) 50%); color: #fff; font-weight: 600; cursor: default; }
        .day.past { opacity: 0.4; }
        .day.pto-selected { background: var(--color-pto); color: #fff; font-weight: 600; }
        .day.activism-selected { background: var(--color-activism); color: #fff; font-weight: 600; }
        .day.personal-selected { background: var(--color-personal); color: #fff; font-weight: 600; }
        .day.wellness-selected { background: var(--color-wellness); color: #fff; font-weight: 600; }
        .day.today { box-shadow: 0 0 0 2px var(--accent-highlight); }

        .day .tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 4px;
        }

        .day:hover .tooltip { display: block; }
        .day .hours-badge {
            position: absolute;
            bottom: 1px;
            right: 1px;
            font-size: 7px;
            font-weight: 600;
            background: rgba(0,0,0,0.3);
            color: #fff;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Mobile Bottom Navigation */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            z-index: 100;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        @media (max-width: 900px) {
            .bottom-nav { display: flex; }
        }

        .nav-items { display: flex; justify-content: space-around; width: 100%; }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 4px 12px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            border: none;
            background: none;
        }
        .nav-item.active { color: var(--accent-primary); }
        .nav-item svg { width: 22px; height: 22px; }

        /* Mobile Tab Content */
        .mobile-tab { display: none; padding: 16px; }
        .mobile-tab.active { display: block; }

        /* Mobile Year View */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 400px) {
            .year-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .mini-month {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
        }

        .mini-month:active { transform: scale(0.98); }
        .mini-month-title { font-size: 11px; font-weight: 600; text-align: center; margin-bottom: 4px; }
        .mini-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .mini-day {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 2px;
            font-size: 6px;
        }
        .mini-day.empty { background: transparent; }
        .mini-day.weekend { background: var(--color-weekend); }
        .mini-day.holiday { background: var(--color-holiday); }
        .mini-day.nine80 { background: var(--color-nine80); }
        .mini-day.holiday-nine80 { background: linear-gradient(135deg, var(--color-holiday) 50%, var(--color-nine80) 50%); }
        .mini-day.pto-selected { background: var(--color-pto); }
        .mini-day.activism-selected { background: var(--color-activism); }
        .mini-day.personal-selected { background: var(--color-personal); }
        .mini-day.wellness-selected { background: var(--color-wellness); }
        .mini-day.today { box-shadow: inset 0 0 0 1px var(--accent-highlight); }

        /* Mobile Month View */
        .month-swiper { overflow: hidden; position: relative; }
        .month-swiper-track { display: flex; transition: transform 0.3s ease-out; }
        .month-swiper-slide { flex: 0 0 100%; padding: 0 4px; }
        .swipe-hint { text-align: center; font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
        .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .month-nav-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-primary);
        }
        .month-nav-title { font-size: 16px; font-weight: 600; }

        /* Mobile Stats */
        .mobile-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
        .mobile-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .mobile-stat-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
        .mobile-stat-card .value { font-size: 20px; font-weight: 600; margin: 4px 0; }
        .mobile-stat-card .detail { font-size: 10px; color: var(--text-secondary); }
        .mobile-stat-card.pto { border-top: 3px solid var(--color-pto); }
        .mobile-stat-card.activism { border-top: 3px solid var(--color-activism); }
        .mobile-stat-card.personal { border-top: 3px solid var(--color-personal); }
        .mobile-stat-card.wellness { border-top: 3px solid var(--color-wellness); }
        .mobile-stat-card.work { border-top: 3px solid var(--accent-primary); }

        /* Mobile Settings */
        .settings-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .settings-section-title { font-size: 12px; font-weight: 600; margin-bottom: 10px; }

        /* FAB */
        .fab {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: #fff;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 90;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 900px) {
            .fab { display: flex; }
        }

        .fab svg { width: 24px; height: 24px; }

        .fab-menu {
            display: none;
            position: fixed;
            bottom: 145px;
            right: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 90;
            overflow: hidden;
        }

        .fab-menu.open { display: block; }
        .fab-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }
        .fab-menu-item:hover { background: var(--bg-secondary); }
        .fab-menu-item.danger { color: var(--color-danger); }
        .fab-menu-item.disabled {
            color: var(--text-muted);
            opacity: 0.45;
            cursor: default;
            pointer-events: none;
        }
        .fab-menu-item.primary-action {
            color: var(--accent-primary);
            font-weight: 600;
        }
        .fab-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }
        .fab-menu-section-title {
            padding: 8px 16px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            cursor: default;
        }

        /* Mobile type selector */
        .mobile-type-bar {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .mobile-type-btn {
            flex: 0 0 auto;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            border: 2px solid transparent;
            cursor: pointer;
            color: #000;
            white-space: nowrap;
        }

        .mobile-type-btn.pto { background: var(--color-pto); }
        .mobile-type-btn.activism { background: var(--color-activism); }
        .mobile-type-btn.personal { background: var(--color-personal); }
        .mobile-type-btn.wellness { background: var(--color-wellness); }
        .mobile-type-btn.active { border-color: var(--text-primary); }

        /* Unit Toggle */
        .unit-toggle {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .unit-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .unit-btn.active {
            background: var(--accent-primary);
            color: #fff;
        }

        /* Sidebar Cards */
        .sidebar-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        /* Improved Collapsible */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 4px 4px;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .collapsible-header:hover { background: var(--bg-tertiary); }
        .collapsible-header:hover .section-title { color: var(--accent-primary); }
        .toggle-icon {
            font-size: 16px;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
            line-height: 1;
        }
        .toggle-icon.open { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .collapsible-content.open { max-height: 2000px; }

        /* Custom Type Modal */
        .custom-type-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .custom-type-modal.open { display: flex; }
        .custom-type-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            max-width: 90vw;
        }
        .custom-type-modal-content h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .modal-btn.primary {
            background: var(--accent-primary);
            color: #fff;
            border-color: var(--accent-primary);
        }

        /* Add Custom Type Button — matches type-btn dimensions */
        .add-custom-btn {
            min-height: 44px;
            padding: 10px 4px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-custom-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Custom type button with delete */
        .custom-type-btn-wrap {
            position: relative;
        }
        .custom-type-btn-wrap .type-btn { width: 100%; }
        .custom-type-btn-wrap .delete-x {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-danger);
            color: #fff;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            display: none;
            border: none;
            padding: 0;
            z-index: 5;
        }
        .custom-type-btn-wrap:hover .delete-x { display: block; }

        /* Type section header row */
        .type-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .type-section-header .section-title { margin-bottom: 0; }
        .clear-all-sm {
            padding: 3px 8px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid var(--color-danger);
            background: transparent;
            color: var(--color-danger);
            cursor: pointer;
            font-family: inherit;
        }
        .clear-all-sm:hover { background: var(--color-danger); color: #fff; }

        /* Admin Dashboard Overlay */
        .admin-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }
        .admin-overlay.open { display: flex; }
        .admin-panel {
            background: #1c1e21;
            color: #e4e5e7;
            border-radius: 12px;
            width: 95vw;
            max-width: 1100px;
            height: 88vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            font-size: 13px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #2e3136;
            flex-shrink: 0;
        }
        .admin-header h2 { font-size: 17px; font-weight: 600; color: #fff; margin-bottom: 2px; }
        .admin-header .admin-subtitle { font-size: 11px; color: #8a8d91; font-weight: 400; }
        .admin-close {
            width: 32px; height: 32px; border-radius: 6px; border: none;
            background: #2e3136; color: #8a8d91; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .admin-close:hover { background: #3a3d42; color: #fff; }
        .admin-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
        .admin-section { margin-bottom: 24px; }
        .admin-section-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.8px; color: #8a8d91; margin-bottom: 12px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .kpi-card {
            background: #25272b;
            border: 1px solid #2e3136;
            border-radius: 8px;
            padding: 14px 16px;
        }
        .kpi-card .kpi-label { font-size: 10px; font-weight: 500; color: #8a8d91; text-transform: uppercase; letter-spacing: 0.3px; }
        .kpi-card .kpi-value { font-size: 22px; font-weight: 600; color: #fff; margin: 4px 0 0; }
        .kpi-card .kpi-sub { font-size: 10px; color: #6b6e73; margin-top: 2px; }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: #25272b;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #2e3136;
        }
        .admin-table th {
            text-align: left; padding: 8px 12px; font-size: 10px;
            font-weight: 600; color: #8a8d91; text-transform: uppercase;
            letter-spacing: 0.3px; background: #2a2c30; border-bottom: 1px solid #2e3136;
        }
        .admin-table td {
            padding: 8px 12px; border-bottom: 1px solid #2e3136; color: #c8cacd;
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table td.num { text-align: right; font-variant-numeric: tabular-nums; color: #fff; font-weight: 500; }
        .admin-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #2e3136;
            flex-shrink: 0;
        }
        .admin-tab {
            flex: 1;
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            background: transparent;
            color: #6b6e73;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        .admin-tab:hover { color: #c8cacd; }
        .admin-tab.active { color: #fff; border-bottom-color: #60a5fa; }
        .admin-status-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 11px;
            color: #6b6e73;
        }
        .admin-status-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .admin-status-dot.green { background: #22c55e; }
        .admin-status-dot.red { background: #ef4444; }
        .admin-status-dot.gray { background: #6b6e73; }
        .admin-footer {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid #2e3136;
            flex-shrink: 0;
        }
        .admin-btn {
            padding: 7px 14px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; font-family: inherit; border: 1px solid #3a3d42;
            background: #2e3136; color: #c8cacd;
        }
        .admin-btn:hover { background: #3a3d42; color: #fff; }
        .admin-btn.danger { border-color: #7f1d1d; color: #fca5a5; }
        .admin-btn.danger:hover { background: #7f1d1d; color: #fff; }
        .admin-privacy-note {
            font-size: 10px; color: #6b6e73; line-height: 1.5;
            background: #25272b; border: 1px solid #2e3136;
            border-radius: 6px; padding: 10px 12px; margin-top: 8px;
        }
        .admin-remote-badge {
            display: inline-block; padding: 2px 8px; border-radius: 3px;
            font-size: 10px; font-weight: 600;
        }
        .admin-remote-badge.off { background: #2e3136; color: #6b6e73; }
        .admin-remote-badge.on { background: #064e3b; color: #6ee7b7; }

        /* ══════════════════════════════════════════════════════════════
           OPTIMIZE PAGE — KPI groups
           ══════════════════════════════════════════════════════════════ */
        .optimize-group {
            margin-bottom: 16px;
        }
        .optimize-group-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .optimize-kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .balance-card.accent {
            border-left: 3px solid var(--accent-primary);
        }
        .mobile-stat-card.accent {
            border-left: 3px solid var(--accent-primary);
        }

        /* ══════════════════════════════════════════════════════════════
           MOBILE UX IMPROVEMENTS — Robinhood-inspired polish
           ══════════════════════════════════════════════════════════════ */

        /* Mobile day tap info toast — replaces hover tooltips on touch */
        .day-info-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 150;
            opacity: 0;
            transition: all 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .day-info-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @media (max-width: 900px) {
            /* ── Hide header-row-2 unit toggle on mobile (moved to Settings tab) ── */
            .header-row-2 { display: none !important; }

            /* ── Mobile Layout adjustments ── */
            .mobile-layout {
                padding-bottom: 72px;
            }

            /* ── Mobile type bar — larger pill buttons ── */
            .mobile-type-bar {
                gap: 8px;
                padding: 10px 12px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .mobile-type-bar::-webkit-scrollbar { display: none; }
            .mobile-type-btn {
                padding: 10px 16px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 24px;
                min-height: 40px;
                border-width: 2.5px;
            }

            /* ── Mobile bottom nav — larger tap targets ── */
            .bottom-nav {
                padding: 6px 0;
                padding-bottom: max(6px, env(safe-area-inset-bottom));
                box-shadow: 0 -1px 8px rgba(0,0,0,0.06);
            }
            .nav-item {
                padding: 6px 16px;
                font-size: 11px;
                gap: 3px;
                min-height: 44px;
            }
            .nav-item svg { width: 24px; height: 24px; }

            /* ── Mobile tab content — better spacing ── */
            .mobile-tab { padding: 12px; }

            /* ── Year grid — tighter cards ── */
            .year-grid { gap: 10px; }
            .mini-month {
                padding: 10px;
                border-radius: 10px;
            }
            .mini-month-title {
                font-size: 12px;
                font-weight: 700;
                margin-bottom: 6px;
            }

            /* ── Month view — better navigation ── */
            .month-nav {
                margin-bottom: 14px;
                padding: 0 2px;
            }
            .month-nav-btn {
                padding: 10px 20px;
                min-height: 44px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 8px;
            }
            .month-nav-title {
                font-size: 18px;
                font-weight: 700;
            }

            /* ── Calendar day cells on mobile — larger, more tappable ── */
            .month-card {
                padding: 14px;
                border-radius: 10px;
            }
            .month-title {
                font-size: 15px;
                font-weight: 700;
                margin-bottom: 10px;
            }
            .weekday-header span {
                font-size: 11px;
                padding: 4px 2px;
            }
            .day {
                font-size: 13px;
                font-weight: 500;
                border-radius: 6px;
                min-height: 38px;
            }
            .day:active:not(.empty):not(.weekend):not(.holiday):not(.nine80):not(.holiday-nine80) {
                transform: scale(0.92);
                transition: transform 0.1s;
            }
            /* Hide hover tooltips on touch devices */
            .day .tooltip { display: none !important; }
            .day .hours-badge {
                font-size: 8px;
                bottom: 2px;
                right: 2px;
                padding: 1px 3px;
            }

            /* ── Mobile stats — improved cards ── */
            .mobile-stats-grid { gap: 10px; margin-bottom: 20px; }
            .mobile-stat-card {
                padding: 14px;
                border-radius: 10px;
            }
            .mobile-stat-card .label {
                font-size: 11px;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            .mobile-stat-card .value {
                font-size: 24px;
                font-weight: 700;
                margin: 6px 0;
            }
            .mobile-stat-card .detail {
                font-size: 11px;
            }

            /* ── Quick actions on mobile — larger, grid layout ── */
            .mobile-tab .quick-section {
                margin-bottom: 16px;
            }
            .mobile-tab .quick-section-title {
                font-size: 12px;
                font-weight: 700;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-muted);
            }
            .mobile-tab .quick-actions {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .mobile-tab .quick-btn {
                padding: 10px 12px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 8px;
                min-height: 44px;
                text-align: center;
            }

            /* ── Mobile clear-all button — visible in stats ── */
            .mobile-clear-all {
                display: block;
                width: 100%;
                margin-top: 12px;
                padding: 12px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 8px;
                border: 1.5px solid var(--color-danger);
                background: transparent;
                color: var(--color-danger);
                cursor: pointer;
                font-family: inherit;
                min-height: 44px;
            }
            .mobile-clear-all:active {
                background: var(--color-danger);
                color: #fff;
            }

            /* ── Opportunities on mobile — better cards ── */
            .mobile-tab .opportunity-list {
                max-height: none;
                overflow-y: visible;
                gap: 8px;
            }
            .mobile-tab .opportunity-item {
                padding: 12px;
                border-radius: 8px;
            }
            .mobile-tab .opportunity-item .title {
                font-size: 14px;
                margin-bottom: 4px;
            }
            .mobile-tab .opportunity-item .details {
                font-size: 12px;
            }
            .mobile-tab .badge {
                font-size: 10px;
                padding: 3px 8px;
                border-radius: 4px;
            }
            .mobile-tab .opp-group-header {
                font-size: 11px;
                margin: 14px 0 6px;
                font-weight: 700;
            }

            /* ── Settings sections on mobile — better spacing ── */
            .settings-section {
                border-radius: 10px;
                padding: 14px;
                margin-bottom: 14px;
            }
            .settings-section-title {
                font-size: 13px;
                font-weight: 700;
                margin-bottom: 12px;
            }
            .settings-section .input-group label {
                font-size: 12px;
                margin-bottom: 4px;
            }
            .settings-section .input-group input,
            .settings-section .input-group select {
                min-height: 40px;
                font-size: 14px;
                padding: 8px 12px;
                border-radius: 8px;
            }
            .settings-section .input-row,
            .settings-section .input-row-3 { gap: 10px; }

            /* ── Holiday list on mobile — bigger tap areas ── */
            .settings-section .holiday-list {
                max-height: 240px;
                gap: 2px;
            }
            .settings-section .holiday-item {
                padding: 10px 8px;
                font-size: 14px;
                min-height: 40px;
                border-radius: 6px;
                gap: 10px;
            }
            .settings-section .holiday-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                flex-shrink: 0;
            }

            /* ── FAB — better mobile placement ── */
            .fab {
                bottom: 86px;
                right: 16px;
                width: 52px;
                height: 52px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            }
            .fab-menu {
                bottom: 148px;
                right: 16px;
                border-radius: 12px;
                min-width: 240px;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            .fab-menu-item {
                padding: 14px 18px;
                font-size: 14px;
                min-height: 44px;
            }
            .fab-menu-section-title {
                padding: 10px 18px 4px;
                font-size: 11px;
            }

            /* ── Toast on mobile ── */
            .toast {
                bottom: 90px;
                max-width: calc(100vw - 32px);
                font-size: 13px;
                padding: 12px 16px;
                border-radius: 12px;
            }

            /* ── Custom type modal on mobile — full width ── */
            .custom-type-modal-content {
                width: calc(100vw - 32px);
                max-width: 400px;
                border-radius: 16px;
                padding: 24px 20px;
            }
            .custom-type-modal-content h3 {
                font-size: 18px;
                margin-bottom: 16px;
            }
            .custom-type-modal-content .input-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .custom-type-modal-content .input-group input,
            .custom-type-modal-content .input-group select {
                min-height: 44px;
                font-size: 15px;
                border-radius: 8px;
                padding: 10px 12px;
            }
            .custom-type-modal-content input[type="color"] {
                min-height: 44px !important;
                height: 44px !important;
            }
            .modal-actions {
                margin-top: 20px;
                gap: 10px;
            }
            .modal-btn {
                flex: 1;
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 8px;
                min-height: 44px;
            }

            /* ── Admin panel on mobile ── */
            .admin-panel {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                max-width: none;
            }
            .admin-header {
                padding: 16px;
            }
            .admin-header h2 { font-size: 16px; }
            .admin-body { padding: 16px; }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .kpi-card {
                padding: 12px;
            }
            .kpi-card .kpi-value { font-size: 18px; }
            .admin-table { font-size: 12px; }
            .admin-table th, .admin-table td {
                padding: 8px 10px;
            }
            .admin-footer {
                padding: 12px 16px;
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }

            /* ── Collapsible sections on mobile ── */
            .sidebar-card {
                border-radius: 10px;
                padding: 14px;
                margin-bottom: 14px;
            }
            .collapsible-header {
                padding: 6px 4px;
                min-height: 44px;
            }
            .collapsible-header .section-title {
                font-size: 12px;
                letter-spacing: 0.8px;
            }
            .toggle-icon {
                font-size: 18px;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                background: var(--bg-tertiary);
            }

            /* ── Type selector on mobile sidebar ── */
            .type-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .type-btn {
                min-height: 48px;
                font-size: 11px;
                padding: 8px 6px;
                border-radius: 10px;
            }
            .type-btn .avail { font-size: 10px; }
            .add-custom-btn {
                min-height: 48px;
                font-size: 11px;
                border-radius: 10px;
            }

            /* ── Clear-all button in type section header ── */
            .type-section-header {
                margin-bottom: 12px;
            }
            .clear-all-sm {
                padding: 6px 12px;
                font-size: 11px;
                border-radius: 6px;
                min-height: 32px;
            }

            /* ── Quick select on desktop sidebar (mobile view) ── */
            .sidebar-card .quick-btn {
                padding: 8px 12px;
                font-size: 11px;
                min-height: 36px;
                border-radius: 6px;
            }

            /* ── Settings unit toggle — larger touch targets ── */
            .unit-toggle-settings {
                display: flex;
                width: 100%;
                gap: 0;
                border-radius: 8px;
                overflow: hidden;
                border: 1.5px solid var(--border-color);
                margin-top: 4px;
            }
            .unit-toggle-settings .unit-btn {
                flex: 1;
                min-height: 44px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 0;
                border: none;
            }

            /* ── Delete X on custom type — visible on mobile (no hover) ── */
            .custom-type-btn-wrap .delete-x {
                display: block;
                width: 20px;
                height: 20px;
                font-size: 12px;
                line-height: 20px;
                top: -6px;
                right: -6px;
            }
        }

        /* Extra small screens (< 400px, e.g. iPhone SE) */
        @media (max-width: 400px) {
            .header h1 { font-size: 15px; }
            .header-controls { gap: 4px; }
            .theme-select { font-size: 11px; padding: 6px 4px; }
            .save-btn { padding: 8px 10px; font-size: 12px; }
            .save-btn svg { width: 12px; height: 12px; }
            .mobile-type-btn { padding: 8px 12px; font-size: 12px; }
            .day { font-size: 12px; min-height: 34px; }
            .month-nav-btn { padding: 8px 14px; font-size: 12px; }
            .type-selector { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body data-theme="light-default">
    <header class="header">
        <h1>Time Off Optimizer</h1>
        <div class="header-controls">
            <select class="theme-select" id="themeSelect" onchange="changeTheme(this.value)">
                <optgroup label="Light">
                    <option value="light-default">Default</option>
                    <option value="light-minimal">Minimal</option>
                    <option value="light-coastal">Coastal</option>
                    <option value="light-bold">Bold</option>
                </optgroup>
                <optgroup label="Dark">
                    <option value="dark-default">Dark</option>
                    <option value="dark-minimal">Dark Minimal</option>
                    <option value="dark-coastal">Dark Coastal</option>
                    <option value="dark-bold">Dark Bold</option>
                </optgroup>
            </select>
            <div class="unit-toggle unit-toggle-desktop">
                <button class="unit-btn active" onclick="setDisplayUnits('hours')">Hours</button>
                <button class="unit-btn" onclick="setDisplayUnits('days')">Days</button>
            </div>
            <button class="save-btn" id="saveBtn" onclick="saveAndShare()">
                <svg id="saveBtnIcon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                <span id="saveBtnText">Save</span>
            </button>
        </div>
        <div class="header-row-2">
            <div class="unit-toggle">
                <button class="unit-btn active" onclick="setDisplayUnits('hours')">Hours</button>
                <button class="unit-btn" onclick="setDisplayUnits('days')">Days</button>
            </div>
        </div>
    </header>

    <div class="toast" id="toast"></div>
    <div class="day-info-toast" id="dayInfoToast"></div>

    <!-- Desktop Layout -->
    <div class="desktop-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('projectedContent', this)">
                    <span class="section-title" style="margin-bottom:0">Projected Year-End</span>
                    <span class="toggle-icon open">▼</span>
                </div>
                <div id="projectedContent" class="collapsible-content open">
                    <div style="margin-top:10px">
                        <div class="stat-card" id="statBoxPto">
                            <div class="stat-label">PTO Balance</div>
                            <div class="stat-value" id="projectedPto">0h</div>
                            <div class="stat-detail" id="ptoDetail">-</div>
                        </div>
                        <div class="balance-grid">
                            <div class="balance-card activism"><div class="label">Activism</div><div class="value" id="projectedActivism">0h</div><div class="detail" id="activismDetail">-</div></div>
                            <div class="balance-card personal"><div class="label">Personal</div><div class="value" id="projectedPersonal">0</div><div class="detail" id="personalDetail">-</div></div>
                            <div class="balance-card wellness"><div class="label">Wellness</div><div class="value" id="projectedWellness">0h</div><div class="detail" id="wellnessDetail">-</div></div>
                            <div class="balance-card pto"><div class="label">Work Days Off</div><div class="value" id="countWorkDaysOff">0</div><div class="detail" id="totalDaysDetail">-</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('optimizeContent', this)">
                    <span class="section-title" style="margin-bottom:0">Optimize</span>
                    <span class="toggle-icon open">▼</span>
                </div>
                <div id="optimizeContent" class="collapsible-content open">
                    <div class="optimize-kpi-grid" style="margin-top:10px">
                        <div class="balance-card accent"><div class="label">Next Long Weekend</div><div class="value" id="dNextLongWeekend">—</div><div class="detail" id="dNextLongWeekendDetail">—</div></div>
                        <div class="balance-card accent"><div class="label">Longest Streak</div><div class="value" id="dLongestStreak">0</div><div class="detail" id="dLongestStreakDetail">days</div></div>
                        <div class="balance-card accent"><div class="label">Efficiency</div><div class="value" id="dEfficiency">—</div><div class="detail" id="dEfficiencyDetail">ratio</div></div>
                        <div class="balance-card accent"><div class="label">Fridays Off</div><div class="value" id="dFridaysOff">0</div><div class="detail" id="dFridaysOffDetail">planned</div></div>
                        <div class="balance-card accent"><div class="label">Breaks Planned</div><div class="value" id="dBreaksPlanned">0</div><div class="detail" id="dBreaksPlannedDetail">—</div></div>
                        <div class="balance-card accent"><div class="label">Avg Break</div><div class="value" id="dAvgBreakLen">—</div><div class="detail" id="dAvgBreakLenDetail">days</div></div>
                        <div class="balance-card accent" style="grid-column:1/-1"><div class="label">Streaks by Tier</div><div class="value" id="dStreakTiers">—</div><div class="detail" id="dStreakTiersDetail">—</div></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="type-section-header">
                    <div class="section-title">Select Time Off Type</div>
                    <button class="clear-all-sm" onclick="clearAllSelections()">Clear All</button>
                </div>
                <div class="type-selector" id="typeSelector">
                    <button class="type-btn pto active" onclick="setTimeOffType('pto')">PTO<span class="avail" id="ptoAvailDisplay">0h</span></button>
                    <button class="type-btn activism" onclick="setTimeOffType('activism')">Activism<span class="avail" id="activismAvailDisplay">0h</span></button>
                    <button class="type-btn personal" onclick="setTimeOffType('personal')">Personal<span class="avail" id="personalAvailDisplay">0d</span></button>
                    <button class="type-btn wellness" onclick="setTimeOffType('wellness')">Wellness<span class="avail" id="wellnessAvailDisplay">0h</span></button>
                    <!-- Custom type buttons injected before addCustomBtn by renderCustomTypeButtons() -->
                    <button class="add-custom-btn" id="addCustomBtn" onclick="openCustomTypeModal()">+ Add</button>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('settingsContent', this)">
                    <span class="section-title" style="margin-bottom:0">Settings</span>
                    <span class="toggle-icon open">▼</span>
                </div>
                <div id="settingsContent" class="collapsible-content open">
                    <div class="input-row" style="margin-top:10px">
                        <div class="input-group">
                            <label>Year</label>
                            <select id="year" onchange="regenerate()"></select>
                        </div>
                        <div class="input-group">
                            <label>Years of Service</label>
                            <select id="yearsOfService" onchange="applyServicePreset()">
                                <option value="0-3" selected>0-3 years</option>
                                <option value="4-6">4-6 years</option>
                                <option value="7-9">7-9 years</option>
                                <option value="10+">10+ years</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div id="customPtoFields" class="custom-pto-fields">
                        <div class="input-row">
                            <div class="input-group"><label>PTO/Paycheck</label><input type="number" id="customPtoPerPaycheck" step="0.01" value="3.07" onchange="applyCustomPto()"></div>
                            <div class="input-group"><label>Max Cap</label><input type="number" id="customMaxPto" value="120" onchange="applyCustomPto()"></div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group"><label>First Paycheck</label><input type="date" id="nextPaycheck" onchange="regenerate()"></div>
                        <div class="input-group"><label>First 9/80 Friday</label><input type="date" id="next980Friday" onchange="regenerate()"></div>
                    </div>
                    <div class="input-group"><label>Year-End PTO Goal</label><input type="number" id="yearEndGoal" placeholder="Optional" onchange="recalculate()"></div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('balancesContent', this)">
                    <span class="section-title" style="margin-bottom:0">Current Balances</span>
                    <span class="toggle-icon open">▼</span>
                </div>
                <div id="balancesContent" class="collapsible-content open">
                    <div style="margin-top:10px">
                        <label style="font-size:10px;color:var(--text-muted)">PTO / Vacation</label>
                        <div class="input-row-3">
                            <div class="input-group"><label>Current</label><input type="number" id="currentPto" step="0.01" value="0" onchange="recalculate()"></div>
                            <div class="input-group"><label>Per Pay</label><input type="number" id="ptoPerPaycheck" value="3.07" readonly></div>
                            <div class="input-group"><label>Max</label><input type="number" id="maxPto" value="120" readonly></div>
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label style="font-size:10px;color:var(--text-muted)">Activism (18h/yr)</label>
                        <div class="input-row">
                            <div class="input-group"><label>Current</label><input type="number" id="currentActivism" step="0.01" value="0" min="0" max="18" onchange="recalculate()"></div>
                            <div class="input-group"><label>Yearly</label><input type="number" value="18" readonly></div>
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label style="font-size:10px;color:var(--text-muted)">Personal Days (5/yr)</label>
                        <div class="input-row">
                            <div class="input-group"><label>Current</label>
                                <select id="currentPersonal" onchange="recalculate()">
                                    <option value="0" selected>0 days</option>
                                    <option value="1">1 day</option>
                                    <option value="2">2 days</option>
                                    <option value="3">3 days</option>
                                    <option value="4">4 days</option>
                                    <option value="5">5 days</option>
                                </select>
                            </div>
                            <div class="input-group"><label>Max</label><input type="text" value="5 days" readonly></div>
                        </div>
                    </div>
                    <div style="margin-top:8px">
                        <label style="font-size:10px;color:var(--text-muted)">Wellness / Sick</label>
                        <div class="input-row-3">
                            <div class="input-group"><label>Current</label><input type="number" id="currentWellness" step="0.01" value="0" onchange="recalculate()"></div>
                            <div class="input-group"><label>Per Pay</label><input type="text" value="2.76" readonly></div>
                            <div class="input-group"><label>Max</label><input type="text" value="108" readonly></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('holidaysContent', this)">
                    <span class="section-title" style="margin-bottom:0">Holidays</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div id="holidaysContent" class="collapsible-content">
                    <div class="holiday-list" id="holidayCheckboxes" style="margin-top:10px"></div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('quickSelectContent', this)">
                    <span class="section-title" style="margin-bottom:0">Quick Select</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div id="quickSelectContent" class="collapsible-content">
                    <div style="margin-top:10px">
                        <div class="quick-section">
                            <div class="quick-section-title">Combos</div>
                            <div class="quick-actions">
                                <button class="quick-btn accent" onclick="selectAllType('mega')">Mega</button>
                                <button class="quick-btn accent" onclick="selectAllType('super')">Super</button>
                                <button class="quick-btn" onclick="selectAllType('4day')">4-Day</button>
                            </div>
                        </div>
                        <div class="quick-section">
                            <div class="quick-section-title">Fridays</div>
                            <div class="quick-actions">
                                <button class="quick-btn" onclick="selectAllType('allFridays')">All Fridays</button>
                                <button class="quick-btn" onclick="selectAllType('summer')">Summer</button>
                            </div>
                        </div>
                        <div class="quick-section" id="twoForFiveSection"><div class="quick-section-title">2 for 5 Fridays</div><div class="quick-actions" id="twoForFiveButtons"></div></div>
                        <div class="quick-section" id="threeForFiveSection"><div class="quick-section-title">3 for 5 Fridays</div><div class="quick-actions" id="threeForFiveButtons"></div></div>
                        <div class="quick-section"><div class="quick-actions"><button class="quick-btn clear" onclick="clearAllSelections()">Clear All</button></div></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="collapsible-header" onclick="toggleSection('opportunitiesContent', this)">
                    <span class="section-title" style="margin-bottom:0">Opportunities</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div id="opportunitiesContent" class="collapsible-content">
                    <div class="opportunity-list" id="opportunityList" style="margin-top:10px"></div>
                </div>
            </div>
        </aside>

        <main class="content-area">
            <div class="chart-section">
                <h3>PTO Balance Projection</h3>
                <div class="projection-chart" id="projectionChart"></div>
                <div class="chart-data-table" id="ptoDataTable"></div>
            </div>
            <div class="chart-section">
                <h3>Wellness Balance Projection</h3>
                <div class="projection-chart" id="wellnessProjectionChart"></div>
                <div class="chart-data-table" id="wellnessDataTable"></div>
            </div>
            <div class="chart-section">
                <h3>Personal Days &amp; Activism Hours</h3>
                <div class="chart-data-table" id="activismPersonalDataTable"></div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:var(--color-weekend)"></div><span>Weekend</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-holiday)"></div><span>Holiday</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-nine80)"></div><span>9/80</span></div>
                <div class="legend-item"><div class="legend-color split"></div><span>Holiday+9/80</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-pto)"></div><span>PTO</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-activism)"></div><span>Activism</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-personal)"></div><span>Personal</span></div>
                <div class="legend-item"><div class="legend-color" style="background:var(--color-wellness)"></div><span>Wellness</span></div>
                <span id="customLegendItems"></span>
            </div>
            <div class="calendar-container" id="calendarContainer"></div>
        </main>
    </div>

    <!-- Mobile Layout -->
    <div class="mobile-layout">
        <div class="mobile-type-bar" id="mobileTypeBar">
            <button class="mobile-type-btn pto active" onclick="setTimeOffType('pto')">PTO</button>
            <button class="mobile-type-btn activism" onclick="setTimeOffType('activism')">Activism</button>
            <button class="mobile-type-btn personal" onclick="setTimeOffType('personal')">Personal</button>
            <button class="mobile-type-btn wellness" onclick="setTimeOffType('wellness')">Wellness</button>
        </div>

        <div id="mobileYearTab" class="mobile-tab active">
            <div class="year-grid" id="yearGrid"></div>
        </div>

        <div id="mobileMonthTab" class="mobile-tab">
            <div class="month-nav">
                <button class="month-nav-btn" onclick="prevMonth()">← Prev</button>
                <span class="month-nav-title" id="currentMonthTitle">January</span>
                <button class="month-nav-btn" onclick="nextMonth()">Next →</button>
            </div>
            <div id="mobileMonthCalendar"></div>
        </div>

        <div id="mobileStatsTab" class="mobile-tab">
            <!-- Balances Group -->
            <div class="optimize-group">
                <div class="optimize-group-title">Balances</div>
                <div class="mobile-stats-grid">
                    <div class="mobile-stat-card pto"><div class="label">PTO</div><div class="value" id="mProjPto">0h</div><div class="detail" id="mPtoDetail">-</div></div>
                    <div class="mobile-stat-card activism"><div class="label">Activism</div><div class="value" id="mProjActivism">0h</div><div class="detail" id="mActivismDetail">-</div></div>
                    <div class="mobile-stat-card personal"><div class="label">Personal</div><div class="value" id="mProjPersonal">0d</div><div class="detail" id="mPersonalDetail">-</div></div>
                    <div class="mobile-stat-card wellness"><div class="label">Wellness</div><div class="value" id="mProjWellness">0h</div><div class="detail" id="mWellnessDetail">-</div></div>
                </div>
            </div>

            <!-- Planning Group -->
            <div class="optimize-group">
                <div class="optimize-group-title">Planning</div>
                <div class="mobile-stats-grid">
                    <div class="mobile-stat-card work"><div class="label">Work Days Off</div><div class="value" id="mWorkDays">0</div><div class="detail" id="mTotalDetail">Total days off (incl. weekends): 0</div></div>
                    <div class="mobile-stat-card accent"><div class="label">Next Long Weekend</div><div class="value" id="mNextLongWeekend">—</div><div class="detail" id="mNextLongWeekendDetail">—</div></div>
                </div>
            </div>

            <!-- Optimization Group -->
            <div class="optimize-group">
                <div class="optimize-group-title">Optimization</div>
                <div class="mobile-stats-grid">
                    <div class="mobile-stat-card accent"><div class="label">Longest Streak Off</div><div class="value" id="mLongestStreak">0</div><div class="detail" id="mLongestStreakDetail">days</div></div>
                    <div class="mobile-stat-card accent"><div class="label">Days Off Efficiency</div><div class="value" id="mEfficiency">—</div><div class="detail" id="mEfficiencyDetail">ratio</div></div>
                </div>
            </div>

            <!-- Patterns Group -->
            <div class="optimize-group">
                <div class="optimize-group-title">Patterns</div>
                <div class="mobile-stats-grid">
                    <div class="mobile-stat-card accent"><div class="label">Streaks by Tier</div><div class="value" id="mStreakTiers">—</div><div class="detail" id="mStreakTiersDetail">—</div></div>
                    <div class="mobile-stat-card accent"><div class="label">Fridays Off</div><div class="value" id="mFridaysOff">0</div><div class="detail" id="mFridaysOffDetail">planned</div></div>
                    <div class="mobile-stat-card accent"><div class="label">Breaks Planned</div><div class="value" id="mBreaksPlanned">0</div><div class="detail" id="mBreaksPlannedDetail">—</div></div>
                    <div class="mobile-stat-card accent"><div class="label">Avg Break Length</div><div class="value" id="mAvgBreakLen">—</div><div class="detail" id="mAvgBreakLenDetail">days</div></div>
                </div>
            </div>

            <div class="quick-section">
                <div class="quick-section-title">Quick Actions</div>
                <div class="quick-actions">
                    <button class="quick-btn accent" onclick="selectAllType('mega')">Mega Combos</button>
                    <button class="quick-btn accent" onclick="selectAllType('super')">Super Combos</button>
                    <button class="quick-btn" onclick="selectAllType('4day')">4-Day Weekends</button>
                    <button class="quick-btn" onclick="selectAllType('allFridays')">All Fridays</button>
                </div>
            </div>
            <button class="mobile-clear-all" onclick="if(confirm('Clear all selected days?'))clearAllSelections()">Clear All Selections</button>
            <div class="opportunity-list" id="mobileOpportunityList" style="margin-top:16px"></div>
        </div>

        <div id="mobileSettingsTab" class="mobile-tab">
            <div class="settings-section">
                <div class="settings-section-title">Display</div>
                <div class="input-group">
                    <label>Show values in</label>
                    <div class="unit-toggle unit-toggle-settings" id="settingsUnitToggle">
                        <button class="unit-btn active" onclick="setDisplayUnits('hours')">Hours</button>
                        <button class="unit-btn" onclick="setDisplayUnits('days')">Days</button>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">General</div>
                <div class="input-row">
                    <div class="input-group"><label>Year</label><select id="mYear" onchange="document.getElementById('year').value=this.value;regenerate()"></select></div>
                    <div class="input-group"><label>Service Years</label>
                        <select id="mYearsOfService" onchange="document.getElementById('yearsOfService').value=this.value;applyServicePreset()">
                            <option value="0-3" selected>0-3 yrs</option>
                            <option value="4-6">4-6 yrs</option>
                            <option value="7-9">7-9 yrs</option>
                            <option value="10+">10+ yrs</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>First Paycheck</label><input type="date" id="mNextPaycheck" onchange="document.getElementById('nextPaycheck').value=this.value;regenerate()"></div>
                    <div class="input-group"><label>First 9/80 Fri</label><input type="date" id="mNext980Friday" onchange="document.getElementById('next980Friday').value=this.value;regenerate()"></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Current Balances</div>
                <div class="input-row">
                    <div class="input-group"><label>PTO Hours</label><input type="number" id="mCurrentPto" step="0.01" value="0" onchange="document.getElementById('currentPto').value=this.value;recalculate()"></div>
                    <div class="input-group"><label>Activism</label><input type="number" id="mCurrentActivism" step="0.01" value="0" onchange="document.getElementById('currentActivism').value=this.value;recalculate()"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Personal Days</label>
                        <select id="mCurrentPersonal" onchange="document.getElementById('currentPersonal').value=this.value;recalculate()">
                            <option value="0" selected>0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                        </select>
                    </div>
                    <div class="input-group"><label>Wellness</label><input type="number" id="mCurrentWellness" step="0.01" value="0" onchange="document.getElementById('currentWellness').value=this.value;recalculate()"></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Holidays</div>
                <div class="holiday-list" id="mHolidayCheckboxes"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-items">
            <button class="nav-item active" onclick="switchMobileTab('year', this)">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                Year
            </button>
            <button class="nav-item" onclick="switchMobileTab('month', this)">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M3 10h18M8 2v4M16 2v4"/></svg>
                Month
            </button>
            <button class="nav-item" onclick="switchMobileTab('stats', this)">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                Optimize
            </button>
            <button class="nav-item" onclick="switchMobileTab('settings', this)">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                Settings
            </button>
        </div>
    </nav>

    <!-- FAB -->
    <button class="fab" id="fab" onclick="toggleFabMenu()">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    </button>
    <div class="fab-menu" id="fabMenu"></div>

    <!-- Custom Type Modal -->
    <div class="custom-type-modal" id="customTypeModal">
        <div class="custom-type-modal-content">
            <h3>Add Custom Time Off Type</h3>
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="customTypeName" placeholder="e.g., Jury Duty" maxlength="20">
            </div>
            <div class="input-group" style="margin-top:8px">
                <label>Color</label>
                <input type="color" id="customTypeColor" value="#6366f1" style="width:100%;height:36px;padding:2px;cursor:pointer">
            </div>
            <div class="input-group" style="margin-top:8px">
                <label>Counts toward days off totals?</label>
                <select id="customTypeCountsAsDayOff">
                    <option value="no" selected>No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="saveCustomType()">Save</button>
                <button class="modal-btn" onclick="closeCustomTypeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin KPI Dashboard -->
    <div class="admin-overlay" id="adminOverlay">
        <div class="admin-panel">
            <div class="admin-header">
                <div>
                    <h2>Usage Dashboard</h2>
                    <div class="admin-subtitle">Privacy-safe, anonymous metrics
                        <span class="admin-remote-badge off" id="adminRemoteBadge">Remote: Off</span>
                    </div>
                </div>
                <button class="admin-close" onclick="closeAdmin()">&times;</button>
            </div>
            <!-- Admin tabs removed — sitewide only -->
            <div class="admin-body" id="adminBody"></div>
            <div class="admin-footer">
                <button class="admin-btn" onclick="exportTelemetry()">Export JSON</button>
                <button class="admin-btn danger" onclick="resetTelemetry()">Reset Metrics</button>
            </div>
        </div>
    </div>

    <script>
        // Telemetry (privacy-safe, device-local, aggregated counters only)
        // ── ADMIN NOTES ──────────────────────────────────────────────────
        // Static GitHub Pages cannot store global counters. To enable
        // sitewide KPIs you need a server-side endpoint.
        //
        // Recommended: Cloudflare Worker + KV.
        //   1. Deploy cloudflare-worker.js (already handles /api/shorten;
        //      telemetry routes added to the same worker).
        //   2. Create a KV namespace "TELEMETRY" and bind it to the worker.
        //   3. Set TELEMETRY_REMOTE_ENDPOINT below to your worker URL
        //      (e.g. "https://pt-onia.app/api/telemetry") and set
        //      TELEMETRY_REMOTE_ENABLED = true.
        //   4. The worker aggregates counters server-side. No PII is sent.
        // ──────────────────────────────────────────────────────────────────
        const TELEMETRY_REMOTE_ENDPOINT = 'https://pt-onia.app/api/telemetry';
        const TELEMETRY_REMOTE_ENABLED = true;
        const TELEMETRY_FLUSH_INTERVAL_MS = 30000; // flush batch every 30s
        const TELEMETRY_KEY = 'ptoOptimizer_telemetry_v1';
        const TELEMETRY_VISITED_KEY = 'ptoOptimizer_hasVisited';
        const CUSTOM_TYPES_STORAGE_KEY = 'timeoff_customTypes';
        const telemetry = (() => {
            const defaults = {
                v: 1, totalSessions: 0, totalActiveMs: 0, sessionsOver5Min: 0,
                saveClicks: 0, saveUsedSessions: 0,
                units_hours: 0, units_days: 0,
                theme: {}, customTypeCreateAttempts: 0, customTypeCreatedCount: 0,
                quickSelect: { mega: 0, super: 0, '4day': 0, allFridays: 0, summer: 0, '2for5': 0, '3for5': 0 },
                opportunityClickCount: 0, clearAllSelectionsCount: 0,
                returningVisitsCount: 0, errorsCaughtCount: 0
            };
            let data;
            try { data = JSON.parse(localStorage.getItem(TELEMETRY_KEY)); } catch {}
            if (!data || data.v !== 1) data = { ...defaults };
            else data = { ...defaults, ...data, theme: { ...data.theme }, quickSelect: { ...defaults.quickSelect, ...data.quickSelect } };

            let activeMs = 0;
            let lastVisibleTime = document.hidden ? null : Date.now();
            let saveUsedThisSession = false;
            let saveTimer = null;
            let saveDirty = false;

            function persistNow() {
                if (!saveDirty) return;
                saveDirty = false;
                try {
                    localStorage.setItem(TELEMETRY_KEY, JSON.stringify(data));
                } catch {}
            }
            function save(immediate = false) {
                saveDirty = true;
                if (immediate) {
                    if (saveTimer) {
                        clearTimeout(saveTimer);
                        saveTimer = null;
                    }
                    persistNow();
                    return;
                }
                if (saveTimer) return;
                saveTimer = setTimeout(() => {
                    saveTimer = null;
                    persistNow();
                }, 250);
            }
            function increment(key) { data[key] = (data[key] || 0) + 1; save(); remoteBatch.add(key, 1); }
            function incrementNested(group, key) {
                if (!data[group]) data[group] = {};
                data[group][key] = (data[group][key] || 0) + 1;
                save();
                remoteBatch.addNested(group, key, 1);
            }

            // Returning visitor
            try {
                if (localStorage.getItem(TELEMETRY_VISITED_KEY)) {
                    data.returningVisitsCount++;
                    save();
                }
                localStorage.setItem(TELEMETRY_VISITED_KEY, '1');
            } catch {}

            function onVisChange() {
                if (document.hidden) {
                    if (lastVisibleTime) { activeMs += Date.now() - lastVisibleTime; lastVisibleTime = null; }
                } else { lastVisibleTime = Date.now(); }
            }
            function sessionEnd() {
                if (lastVisibleTime) { activeMs += Date.now() - lastVisibleTime; lastVisibleTime = null; }
                data.totalSessions++;
                data.totalActiveMs += activeMs;
                if (activeMs >= 300000) data.sessionsOver5Min++;
                if (saveUsedThisSession) data.saveUsedSessions++;
                save(true);
                // Flush remaining remote batch + session counters
                remoteBatch.add('totalSessions', 1);
                remoteBatch.add('totalActiveMs', activeMs);
                if (activeMs >= 300000) remoteBatch.add('sessionsOver5Min', 1);
                if (saveUsedThisSession) remoteBatch.add('saveUsedSessions', 1);
                remoteBatch.flush(true); // true = use sendBeacon
            }
            document.addEventListener('visibilitychange', onVisChange);
            window.addEventListener('pagehide', sessionEnd);

            return {
                get data() { return data; },
                increment,
                incrementNested,
                markSaveUsed() { saveUsedThisSession = true; },
                save,
                reset() {
                    Object.keys(defaults).forEach(k => data[k] = typeof defaults[k] === 'object' ? JSON.parse(JSON.stringify(defaults[k])) : defaults[k]);
                    save(true);
                }
            };
        })();

        // Remote telemetry batching — accumulates increments, flushes periodically
        const remoteBatch = (() => {
            let batch = {}; // { key: delta } for flat counters
            let nested = {}; // { group: { key: delta } } for nested counters
            let flushTimer = null;
            let remoteAlive = null; // null = unknown, true/false after first attempt
            let sitewideCache = null;
            let sitewideLastFetch = 0;

            function isEmpty() {
                return Object.keys(batch).length === 0 && Object.keys(nested).length === 0;
            }

            function add(key, delta) {
                if (!TELEMETRY_REMOTE_ENABLED) return;
                batch[key] = (batch[key] || 0) + delta;
                scheduleFlush();
            }

            function addNested(group, key, delta) {
                if (!TELEMETRY_REMOTE_ENABLED) return;
                if (!nested[group]) nested[group] = {};
                nested[group][key] = (nested[group][key] || 0) + delta;
                scheduleFlush();
            }

            function scheduleFlush() {
                if (flushTimer) return;
                flushTimer = setTimeout(() => { flushTimer = null; flush(false); }, TELEMETRY_FLUSH_INTERVAL_MS);
            }

            function mergeBack(flat, nestedEntries) {
                Object.entries(flat).forEach(([key, delta]) => {
                    batch[key] = (batch[key] || 0) + delta;
                });
                Object.entries(nestedEntries).forEach(([group, entries]) => {
                    if (!nested[group]) nested[group] = {};
                    Object.entries(entries).forEach(([key, delta]) => {
                        nested[group][key] = (nested[group][key] || 0) + delta;
                    });
                });
            }

            function flush(useBeacon) {
                if (!TELEMETRY_REMOTE_ENABLED || !TELEMETRY_REMOTE_ENDPOINT || isEmpty()) return;
                if (flushTimer) {
                    clearTimeout(flushTimer);
                    flushTimer = null;
                }

                const outBatch = { ...batch };
                const outNested = { ...nested };
                const payload = JSON.stringify({ increments: outBatch, nested: outNested });
                batch = {};
                nested = {};

                if (useBeacon && navigator.sendBeacon) {
                    const queued = navigator.sendBeacon(
                        TELEMETRY_REMOTE_ENDPOINT,
                        new Blob([payload], { type: 'application/json' })
                    );
                    if (!queued) {
                        remoteAlive = false;
                        mergeBack(outBatch, outNested);
                        scheduleFlush();
                    }
                } else {
                    fetch(TELEMETRY_REMOTE_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: payload,
                        keepalive: true
                    }).then(r => {
                        remoteAlive = r.ok;
                        if (!r.ok) {
                            mergeBack(outBatch, outNested);
                            scheduleFlush();
                        }
                    }).catch(() => {
                        remoteAlive = false;
                        mergeBack(outBatch, outNested);
                        scheduleFlush();
                    });
                }
            }

            async function fetchSitewide(force) {
                if (!TELEMETRY_REMOTE_ENABLED || !TELEMETRY_REMOTE_ENDPOINT) return null;
                if (!force && sitewideCache && Date.now() - sitewideLastFetch < 60000) return sitewideCache;
                try {
                    const r = await fetch(TELEMETRY_REMOTE_ENDPOINT, { method: 'GET' });
                    if (!r.ok) { remoteAlive = false; return null; }
                    remoteAlive = true;
                    sitewideCache = await r.json();
                    sitewideLastFetch = Date.now();
                    return sitewideCache;
                } catch { remoteAlive = false; return null; }
            }

            // Ping on startup to determine remote status
            if (TELEMETRY_REMOTE_ENABLED && TELEMETRY_REMOTE_ENDPOINT) {
                fetch(TELEMETRY_REMOTE_ENDPOINT, { method: 'GET' })
                    .then(r => { remoteAlive = r.ok; })
                    .catch(() => { remoteAlive = false; });
            }

            return {
                add,
                addNested,
                flush,
                fetchSitewide,
                get alive() { return remoteAlive; },
                get enabled() { return TELEMETRY_REMOTE_ENABLED && !!TELEMETRY_REMOTE_ENDPOINT; }
            };
        })();

        // Admin panel (sitewide only)
        let adminTab = 'sitewide';
        function openAdmin() {
            adminTab = 'sitewide';
            renderAdminDashboard();
            document.getElementById('adminOverlay').classList.add('open');
        }
        function closeAdmin() { document.getElementById('adminOverlay').classList.remove('open'); }
        function renderKpiHtml(d, label) {
            const avgMs = d.totalSessions > 0 ? d.totalActiveMs / d.totalSessions : 0;
            const avgDur = avgMs >= 60000 ? (avgMs / 60000).toFixed(1) + 'm' : (avgMs / 1000).toFixed(0) + 's';
            const savePct = d.totalSessions > 0 ? ((d.saveUsedSessions / d.totalSessions) * 100).toFixed(0) + '%' : '—';
            const themeObj = d.theme || {};
            const qsObj = d.quickSelect || {};
            const themeRows = Object.entries(themeObj).sort((a,b) => b[1] - a[1]).map(([k,v]) =>
                `<tr><td>${k}</td><td class="num">${v}</td></tr>`).join('') || '<tr><td colspan="2" style="color:#6b6e73">No data yet</td></tr>';
            const qsRows = Object.entries(qsObj).map(([k,v]) =>
                `<tr><td>${k}</td><td class="num">${v}</td></tr>`).join('');
            return `
                <div class="admin-section">
                    <div class="admin-section-title">Sessions — ${label}</div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-label">Total Sessions</div><div class="kpi-value">${d.totalSessions || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Sessions &ge; 5 min</div><div class="kpi-value">${d.sessionsOver5Min || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Avg Duration</div><div class="kpi-value">${avgDur}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Save Clicks</div><div class="kpi-value">${d.saveClicks || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Save Adoption</div><div class="kpi-value">${savePct}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Returning Visits</div><div class="kpi-value">${d.returningVisitsCount || 0}</div></div>
                    </div>
                </div>
                <div class="admin-section">
                    <div class="admin-section-title">Engagement</div>
                    <div class="kpi-grid" style="margin-bottom:12px">
                        <div class="kpi-card"><div class="kpi-label">Units: Hours</div><div class="kpi-value">${d.units_hours || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Units: Days</div><div class="kpi-value">${d.units_days || 0}</div></div>
                    </div>
                    <table class="admin-table"><tr><th>Theme / Palette</th><th style="text-align:right">Count</th></tr>${themeRows}</table>
                </div>
                <div class="admin-section">
                    <div class="admin-section-title">Feature Usage</div>
                    <div class="kpi-grid" style="margin-bottom:12px">
                        <div class="kpi-card"><div class="kpi-label">Custom Types Created</div><div class="kpi-value">${d.customTypeCreatedCount || 0}</div><div class="kpi-sub">${d.customTypeCreateAttempts || 0} modal opens</div></div>
                        <div class="kpi-card"><div class="kpi-label">Opportunities Toggled</div><div class="kpi-value">${d.opportunityClickCount || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Clear All</div><div class="kpi-value">${d.clearAllSelectionsCount || 0}</div></div>
                        <div class="kpi-card"><div class="kpi-label">Errors Caught</div><div class="kpi-value">${d.errorsCaughtCount || 0}</div></div>
                    </div>
                    <table class="admin-table"><tr><th>Quick Select Action</th><th style="text-align:right">Count</th></tr>${qsRows}</table>
                </div>`;
        }
        function renderAdminDashboard() {
            const remoteOn = remoteBatch.enabled;
            const badge = document.getElementById('adminRemoteBadge');
            badge.className = 'admin-remote-badge ' + (remoteOn && remoteBatch.alive !== false ? 'on' : remoteOn ? 'off' : 'off');
            badge.textContent = 'Remote: ' + (remoteOn ? (remoteBatch.alive === false ? 'Error' : remoteBatch.alive ? 'Live' : 'Pending') : 'Off');

            // Sitewide only
            if (!remoteOn) {
                document.getElementById('adminBody').innerHTML = `
                    <div class="admin-section" style="padding:40px 0;text-align:center">
                        <div style="font-size:14px;color:#8a8d91;margin-bottom:8px">Sitewide tracking is disabled</div>
                        <div style="font-size:11px;color:#6b6e73;max-width:400px;margin:0 auto;line-height:1.5">
                            Set <code style="color:#60a5fa">TELEMETRY_REMOTE_ENABLED = true</code> and configure
                            <code style="color:#60a5fa">TELEMETRY_REMOTE_ENDPOINT</code> pointing to a Cloudflare Worker
                            with a KV namespace to enable sitewide anonymous metrics.
                        </div>
                    </div>`;
                return;
            }
            document.getElementById('adminBody').innerHTML = `
                <div class="admin-status-row">
                    <span class="admin-status-dot ${remoteBatch.alive === true ? 'green' : remoteBatch.alive === false ? 'red' : 'gray'}"></span>
                    Endpoint: ${TELEMETRY_REMOTE_ENDPOINT}
                </div>
                <div style="text-align:center;padding:30px 0;color:#6b6e73">Loading sitewide data&hellip;</div>`;
            remoteBatch.fetchSitewide(true).then(sw => {
                if (!sw) {
                    document.getElementById('adminBody').innerHTML = `
                        <div class="admin-status-row">
                            <span class="admin-status-dot red"></span>
                            Endpoint unreachable: ${TELEMETRY_REMOTE_ENDPOINT}
                        </div>
                        <div style="text-align:center;padding:30px 0;color:#6b6e73">
                            Could not reach the telemetry endpoint. Check that the Cloudflare Worker is deployed and the TELEMETRY KV namespace is bound.
                        </div>`;
                    return;
                }
                document.getElementById('adminBody').innerHTML = `
                    <div class="admin-status-row">
                        <span class="admin-status-dot green"></span>
                        Endpoint: ${TELEMETRY_REMOTE_ENDPOINT}
                    </div>` + renderKpiHtml(sw, 'All Visitors (anonymous)') + `
                    <div class="admin-section">
                        <div class="admin-section-title">Privacy</div>
                        <div class="admin-privacy-note">
                            Sitewide metrics are anonymous aggregated counters only. No IPs, user identifiers, or personal
                            scheduling data are stored. Data is kept in Cloudflare KV on your account.
                        </div>
                    </div>`;
            });
        }
        function exportTelemetry() {
            const json = JSON.stringify(remoteBatch.alive ? 'Use GET endpoint for sitewide export' : { note: 'Remote not connected' }, null, 2);
            if (navigator.clipboard) { navigator.clipboard.writeText(json).then(() => showToast('Telemetry JSON copied to clipboard')); }
            else { const b = new Blob([json], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'telemetry.json'; a.click(); }
        }
        async function resetTelemetry() {
            if (!confirm('Reset SITEWIDE metrics on the server? This cannot be undone.')) return;
            try {
                const response = await fetch(TELEMETRY_REMOTE_ENDPOINT, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to reset');
                showToast('Sitewide metrics reset');
            } catch {
                showToast('Failed to reset');
            }
            renderAdminDashboard();
        }

        // State
        let state = {
            year: new Date().getFullYear(),
            holidays: {},
            nine80Fridays: {},
            paycheckDates: [],
            selectedDays: { pto: new Set(), activism: new Set(), personal: new Set(), wellness: new Set() },
            currentTimeOffType: 'pto',
            opportunities: [],
            selectedOpportunities: new Set(),
            twoForFiveMonths: [],
            threeForFiveMonths: [],
            allThreeForFiveMonths: [],
            currentMobileMonth: new Date().getMonth(),
            displayUnits: 'hours',
            customTypes: []
        };

        const BUILTIN_TYPES = ['pto', 'activism', 'personal', 'wellness'];

        // Display unit helpers
        function toDisplayValue(hours) {
            if (state.displayUnits === 'days') return (hours / 9).toFixed(1) + 'd';
            return hours.toFixed(1) + 'h';
        }
        function toDisplayInt(hours) {
            if (state.displayUnits === 'days') return (hours / 9).toFixed(1) + 'd';
            return Math.round(hours) + 'h';
        }
        function setDisplayUnits(units) {
            state.displayUnits = units;
            telemetry.increment('units_' + units);
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === units);
            });
            recalculate();
            renderCalendar();
            renderMobileMonth();
            renderOpportunities();
        }

        // Custom type helpers
        function isCustomType(type) { return !BUILTIN_TYPES.includes(type); }
        function getCustomType(id) { return state.customTypes.find(t => t.id === id); }
        function allTypeKeys() { return [...BUILTIN_TYPES, ...state.customTypes.map(t => t.id)]; }
        function selectedTypeForDay(key, typeKeys = allTypeKeys()) {
            for (const type of typeKeys) {
                if (state.selectedDays[type]?.has(key)) return type;
            }
            return null;
        }
        function refreshPlannerViews(includeOpportunities = true) {
            renderCalendar();
            renderMobileYearView();
            renderMobileMonth();
            if (includeOpportunities) renderOpportunities();
            recalculate();
        }
        function textColorForBg(hex) {
            const c = hex.replace('#', '');
            const r = parseInt(c.substr(0, 2), 16), g = parseInt(c.substr(2, 2), 16), b = parseInt(c.substr(4, 2), 16);
            return (r * 299 + g * 587 + b * 114) / 1000 > 150 ? '#000' : '#fff';
        }

        const SERVICE_PRESETS = {
            '0-3': { ptoPerPaycheck: 3.07, maxPto: 120 },
            '4-6': { ptoPerPaycheck: 4.61, maxPto: 180 },
            '7-9': { ptoPerPaycheck: 6.15, maxPto: 240 },
            '10+': { ptoPerPaycheck: 7.69, maxPto: 300 }
        };

        const ALL_HOLIDAYS = [
            { id: 'newyear', name: "New Year's Day", default: true },
            { id: 'mlk', name: "MLK Day", default: true },
            { id: 'presidents', name: "Presidents Day", default: true },
            { id: 'memorial', name: "Memorial Day", default: true },
            { id: 'juneteenth', name: "Juneteenth", default: true },
            { id: 'independence', name: "Independence Day", default: true },
            { id: 'labor', name: "Labor Day", default: true },
            { id: 'columbus', name: "Columbus Day", default: false },
            { id: 'veterans', name: "Veterans Day", default: false },
            { id: 'thanksgiving', name: "Thanksgiving", default: true },
            { id: 'christmaseve', name: "Christmas Eve", default: true },
            { id: 'christmas', name: "Christmas Day", default: true }
        ];

        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const SHORT_MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // URL State Management
        function encodeState() {
            const data = {
                y: state.year,
                pp: document.getElementById('nextPaycheck').value,
                ff: document.getElementById('next980Friday').value,
                yos: document.getElementById('yearsOfService').value,
                cp: document.getElementById('currentPto').value,
                ca: document.getElementById('currentActivism').value,
                cpr: document.getElementById('currentPersonal').value,
                cw: document.getElementById('currentWellness').value,
                g: document.getElementById('yearEndGoal').value,
                h: ALL_HOLIDAYS.filter(h => document.getElementById(`holiday_${h.id}`)?.checked).map(h => h.id),
                pto: [...state.selectedDays.pto],
                act: [...state.selectedDays.activism],
                per: [...state.selectedDays.personal],
                wel: [...state.selectedDays.wellness],
                t: document.body.getAttribute('data-theme'),
                du: state.displayUnits
            };
            if (document.getElementById('yearsOfService').value === 'custom') {
                data.cpp = document.getElementById('customPtoPerPaycheck').value;
                data.cmp = document.getElementById('customMaxPto').value;
            }
            if (state.customTypes.length > 0) {
                data.ct = state.customTypes.map(ct => ({ id: ct.id, name: ct.name, color: ct.color, cdo: ct.countsAsDayOff }));
                data.ctd = {};
                state.customTypes.forEach(ct => {
                    if (state.selectedDays[ct.id]?.size > 0) data.ctd[ct.id] = [...state.selectedDays[ct.id]];
                });
            }
            return btoa(JSON.stringify(data));
        }

        function decodeState(encoded) {
            try {
                const data = JSON.parse(atob(encoded));
                if (data.y) document.getElementById('year').value = data.y;
                if (data.pp) document.getElementById('nextPaycheck').value = data.pp;
                if (data.ff) document.getElementById('next980Friday').value = data.ff;
                if (data.yos) document.getElementById('yearsOfService').value = data.yos;
                if (data.cp) document.getElementById('currentPto').value = data.cp;
                if (data.ca) document.getElementById('currentActivism').value = data.ca;
                if (data.cpr) document.getElementById('currentPersonal').value = data.cpr;
                if (data.cw) document.getElementById('currentWellness').value = data.cw;
                if (data.g) document.getElementById('yearEndGoal').value = data.g;
                if (data.t) { document.body.setAttribute('data-theme', data.t); document.getElementById('themeSelect').value = data.t; }
                if (data.cpp) document.getElementById('customPtoPerPaycheck').value = data.cpp;
                if (data.cmp) document.getElementById('customMaxPto').value = data.cmp;

                ALL_HOLIDAYS.forEach(h => {
                    const cb = document.getElementById(`holiday_${h.id}`);
                    if (cb) cb.checked = data.h ? data.h.includes(h.id) : h.default;
                });

                applyServicePreset();
                regenerate();

                if (data.pto) data.pto.forEach(d => state.selectedDays.pto.add(d));
                if (data.act) data.act.forEach(d => state.selectedDays.activism.add(d));
                if (data.per) data.per.forEach(d => state.selectedDays.personal.add(d));
                if (data.wel) data.wel.forEach(d => state.selectedDays.wellness.add(d));

                if (data.du) { state.displayUnits = data.du; setDisplayUnits(data.du); }
                if (data.ct) {
                    state.customTypes = data.ct.map(ct => ({ ...ct, countsAsDayOff: !!ct.cdo }));
                    state.customTypes.forEach(ct => { state.selectedDays[ct.id] = new Set(); });
                    if (data.ctd) Object.keys(data.ctd).forEach(id => { if (state.selectedDays[id]) data.ctd[id].forEach(d => state.selectedDays[id].add(d)); });
                    renderCustomTypeButtons();
                    renderMobileTypeBar();
                }

                renderCalendar();
                renderMobileYearView();
                renderMobileMonth();
                recalculate();
                return true;
            } catch (e) {
                console.error('Failed to decode state:', e);
                return false;
            }
        }

        async function requestShortUrl(longUrl, timeoutMs = 1500) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const response = await fetch('/api/shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: longUrl }),
                    signal: controller.signal
                });

                if (!response.ok) return null;

                let data;
                try {
                    data = await response.json();
                } catch {
                    return null;
                }

                return typeof data.shortUrl === 'string' ? data.shortUrl : null;
            } catch {
                return null;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function saveAndShare() {
            telemetry.increment('saveClicks');
            telemetry.markSaveUsed();
            const btn = document.getElementById('saveBtn');
            const btnText = document.getElementById('saveBtnText');
            const btnIcon = document.getElementById('saveBtnIcon');

            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Saving...';
            btnIcon.style.opacity = '0.5';

            const encoded = encodeState();
            const longUrl = `${window.location.origin}${window.location.pathname}#${encoded}`;

            history.replaceState(null, '', `#${encoded}`);

            // Try to get a short URL from the Cloudflare Worker
            let urlToCopy = longUrl;
            let message = 'Link copied! Share it to access from any device.';

            const shortUrl = await requestShortUrl(longUrl);
            if (shortUrl) {
                urlToCopy = shortUrl;
                message = 'Short link copied! ' + shortUrl;
            }

            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Save';
            btnIcon.style.opacity = '1';

            if (navigator.clipboard) {
                try {
                    await navigator.clipboard.writeText(urlToCopy);
                    showToast(message);
                } catch {
                    showToast('URL updated. Copy from address bar.');
                }
            } else {
                showToast('URL updated. Copy from address bar.');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Theme
        function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('preferredTheme', theme);
            telemetry.incrementNested('theme', theme);
        }

        // Helper functions
        function observedDate(date) {
            const d = new Date(date);
            const day = d.getDay();
            if (day === 0) d.setDate(d.getDate() + 1);
            else if (day === 6) d.setDate(d.getDate() - 1);
            return d;
        }

        function nthWeekday(year, month, weekday, n) {
            const first = new Date(year, month, 1);
            const firstWeekday = first.getDay();
            let day = 1 + ((weekday - firstWeekday + 7) % 7) + (n - 1) * 7;
            return new Date(year, month, day);
        }

        function lastWeekday(year, month, weekday) {
            const last = new Date(year, month + 1, 0);
            const lastDay = last.getDate();
            const lastWeekdayOfMonth = last.getDay();
            let diff = (lastWeekdayOfMonth - weekday + 7) % 7;
            return new Date(year, month, lastDay - diff);
        }

        function getHolidayDate(id, year) {
            switch(id) {
                case 'newyear': return observedDate(new Date(year, 0, 1));
                case 'mlk': return nthWeekday(year, 0, 1, 3);
                case 'presidents': return nthWeekday(year, 1, 1, 3);
                case 'memorial': return lastWeekday(year, 4, 1);
                case 'juneteenth': return observedDate(new Date(year, 5, 19));
                case 'independence': return observedDate(new Date(year, 6, 4));
                case 'labor': return nthWeekday(year, 8, 1, 1);
                case 'columbus': return nthWeekday(year, 9, 1, 2);
                case 'veterans': return observedDate(new Date(year, 10, 11));
                case 'thanksgiving': return nthWeekday(year, 10, 4, 4);
                case 'christmaseve': {
                    const xmasEve = new Date(year, 11, 24);
                    const day = xmasEve.getDay();
                    if (day === 0) return new Date(year, 11, 22);
                    if (day === 6) return new Date(year, 11, 23);
                    return xmasEve;
                }
                case 'christmas': return observedDate(new Date(year, 11, 25));
            }
        }

        function dateKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
        function formatShortDate(date) { return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function getHoursForDay(date) { const day = date.getDay(); if (day === 0 || day === 6) return 0; if (day === 5) return 8; return 9; }
        function isPastDate(key) { const today = new Date(); today.setHours(0,0,0,0); return new Date(key + 'T12:00:00') < today; }

        function setTimeOffType(type) {
            state.currentTimeOffType = type;
            document.querySelectorAll('.type-btn, .mobile-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(type) || btn.dataset.customId === type) btn.classList.add('active');
            });
        }

        function applyServicePreset() {
            const preset = document.getElementById('yearsOfService').value;
            const customFields = document.getElementById('customPtoFields');
            if (preset === 'custom') {
                customFields.classList.add('visible');
                applyCustomPto();
            } else {
                customFields.classList.remove('visible');
                if (SERVICE_PRESETS[preset]) {
                    document.getElementById('ptoPerPaycheck').value = SERVICE_PRESETS[preset].ptoPerPaycheck;
                    document.getElementById('maxPto').value = SERVICE_PRESETS[preset].maxPto;
                    recalculate();
                }
            }
        }

        function applyCustomPto() {
            document.getElementById('ptoPerPaycheck').value = document.getElementById('customPtoPerPaycheck').value;
            document.getElementById('maxPto').value = document.getElementById('customMaxPto').value;
            recalculate();
        }

        function toggleSection(contentId, headerEl) {
            const content = document.getElementById(contentId);
            const icon = headerEl.querySelector('.toggle-icon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // Mobile navigation
        function switchMobileTab(tab, btnEl) {
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`mobile${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).classList.add('active');
            btnEl.classList.add('active');
            if (tab === 'month') renderMobileMonth();
            // Show type bar only on year/month tabs
            const typeBar = document.getElementById('mobileTypeBar');
            if (typeBar) typeBar.style.display = (tab === 'year' || tab === 'month') ? '' : 'none';
        }

        function prevMonth() { state.currentMobileMonth = Math.max(0, state.currentMobileMonth - 1); renderMobileMonth(); }
        function nextMonth() { state.currentMobileMonth = Math.min(11, state.currentMobileMonth + 1); renderMobileMonth(); }

        function toggleFabMenu() {
            const menu = document.getElementById('fabMenu');
            if (!menu.classList.contains('open')) renderFabMenu();
            menu.classList.toggle('open');
        }
        function closeFabMenu() { document.getElementById('fabMenu').classList.remove('open'); }

        function renderFabMenu() {
            const menu = document.getElementById('fabMenu');
            menu.innerHTML = '';

            // — Add Custom Time Off Type (primary action) —
            const customBtn = document.createElement('button');
            customBtn.className = 'fab-menu-item primary-action';
            customBtn.textContent = '+ Add Custom Time Off Type';
            customBtn.onclick = () => { closeFabMenu(); openCustomTypeModal(); };
            menu.appendChild(customBtn);

            // — Divider —
            const div1 = document.createElement('div');
            div1.className = 'fab-menu-divider';
            menu.appendChild(div1);

            // — Quick Select section —
            const qsTitle = document.createElement('div');
            qsTitle.className = 'fab-menu-section-title';
            qsTitle.textContent = 'Quick Select';
            menu.appendChild(qsTitle);

            const items = [
                { label: 'Add Mega Combos', action: () => { selectAllType('mega'); closeFabMenu(); } },
                { label: 'Add Super Combos', action: () => { selectAllType('super'); closeFabMenu(); } },
                { label: 'Add 4-Day Weekends', action: () => { selectAllType('4day'); closeFabMenu(); } },
                { label: 'Add Every Friday Off', action: () => { selectAllType('allFridays'); closeFabMenu(); } },
                { label: 'Add Summer Fridays', action: () => { selectAllType('summer'); closeFabMenu(); } },
            ];

            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'fab-menu-item';
                btn.textContent = item.label;
                btn.onclick = item.action;
                menu.appendChild(btn);
            });

            // — 2 for 5 Fridays —
            const twoFor5Btn = document.createElement('button');
            twoFor5Btn.className = 'fab-menu-item';
            if (state.twoForFiveMonths.length === 0) {
                twoFor5Btn.classList.add('disabled');
                twoFor5Btn.textContent = 'Add 2 for 5 Fridays';
            } else {
                const monthNames = state.twoForFiveMonths.map(m => m.name.slice(0, 3)).join(', ');
                twoFor5Btn.textContent = `Add 2 for 5 Fridays (${monthNames})`;
                twoFor5Btn.onclick = () => { selectAll2for5(); closeFabMenu(); };
            }
            menu.appendChild(twoFor5Btn);

            // — 3 for 5 Fridays —
            const threeFor5Btn = document.createElement('button');
            threeFor5Btn.className = 'fab-menu-item';
            if (state.threeForFiveMonths.length === 0) {
                threeFor5Btn.classList.add('disabled');
                threeFor5Btn.textContent = 'Add 3 for 5 Fridays';
            } else {
                const monthNames = state.threeForFiveMonths.map(m => m.name.slice(0, 3)).join(', ');
                threeFor5Btn.textContent = `Add 3 for 5 Fridays (${monthNames})`;
                threeFor5Btn.onclick = () => { selectAll3for5(); closeFabMenu(); };
            }
            menu.appendChild(threeFor5Btn);

            // — Divider —
            const div2 = document.createElement('div');
            div2.className = 'fab-menu-divider';
            menu.appendChild(div2);

            // — Clear All —
            const clearBtn = document.createElement('button');
            clearBtn.className = 'fab-menu-item danger';
            clearBtn.textContent = 'Clear All Selections';
            clearBtn.onclick = () => { if (confirm('Clear all selected days?')) { clearAllSelections(); } closeFabMenu(); };
            menu.appendChild(clearBtn);
        }

        // Initialize
        function init() {
            const savedTheme = localStorage.getItem('preferredTheme');
            if (savedTheme) { document.body.setAttribute('data-theme', savedTheme); document.getElementById('themeSelect').value = savedTheme; }

            const currentYear = new Date().getFullYear();
            [document.getElementById('year'), document.getElementById('mYear')].forEach(sel => {
                for (let y = currentYear - 1; y <= currentYear + 2; y++) {
                    const opt = document.createElement('option');
                    opt.value = y; opt.textContent = y;
                    if (y === currentYear) opt.selected = true;
                    sel.appendChild(opt);
                }
            });

            const year = currentYear;
            document.getElementById('nextPaycheck').value = `${year}-01-08`;
            document.getElementById('next980Friday').value = `${year}-01-09`;
            document.getElementById('mNextPaycheck').value = `${year}-01-08`;
            document.getElementById('mNext980Friday').value = `${year}-01-09`;

            [document.getElementById('holidayCheckboxes'), document.getElementById('mHolidayCheckboxes')].forEach(container => {
                ALL_HOLIDAYS.forEach(h => {
                    const label = document.createElement('label');
                    label.className = 'holiday-item';
                    const id = container.id === 'mHolidayCheckboxes' ? `m_holiday_${h.id}` : `holiday_${h.id}`;
                    label.innerHTML = `<input type="checkbox" id="${id}" ${h.default ? 'checked' : ''} onchange="syncHoliday('${h.id}', this.checked)"><span>${h.name}</span>`;
                    container.appendChild(label);
                });
            });

            // Load custom types from localStorage
            loadCustomTypesFromStorage();

            // Check for URL state
            if (window.location.hash.length > 1) {
                decodeState(window.location.hash.slice(1));
            } else {
                regenerate();
            }
        }

        function syncHoliday(id, checked) {
            const desktop = document.getElementById(`holiday_${id}`);
            const mobile = document.getElementById(`m_holiday_${id}`);
            if (desktop) desktop.checked = checked;
            if (mobile) mobile.checked = checked;
            regenerate();
        }

        function regenerate() {
            state.year = parseInt(document.getElementById('year').value);
            state.holidays = {};
            ALL_HOLIDAYS.forEach(h => {
                const cb = document.getElementById(`holiday_${h.id}`);
                if (cb?.checked) {
                    const date = getHolidayDate(h.id, state.year);
                    if (date) state.holidays[dateKey(date)] = h.name;
                }
            });

            const next980 = new Date(document.getElementById('next980Friday').value + 'T12:00:00');
            state.nine80Fridays = {};
            let current = new Date(next980);
            let temp = new Date(current);
            while (temp.getFullYear() >= state.year - 1) { temp.setDate(temp.getDate() - 14); if (temp.getFullYear() === state.year) state.nine80Fridays[dateKey(temp)] = true; else if (temp.getFullYear() < state.year) break; }
            while (current.getFullYear() <= state.year) { if (current.getFullYear() === state.year) state.nine80Fridays[dateKey(current)] = true; current.setDate(current.getDate() + 14); }

            const nextPaycheck = new Date(document.getElementById('nextPaycheck').value + 'T12:00:00');
            state.paycheckDates = [];
            current = new Date(nextPaycheck);
            temp = new Date(current);
            while (temp.getFullYear() >= state.year - 1) { temp.setDate(temp.getDate() - 14); if (temp.getFullYear() === state.year) state.paycheckDates.unshift(new Date(temp)); else if (temp.getFullYear() < state.year) break; }
            while (current.getFullYear() <= state.year) { if (current.getFullYear() === state.year) state.paycheckDates.push(new Date(current)); current.setDate(current.getDate() + 14); }

            findOpportunities();
            calculateFridayDeals();

            const validDates = new Set();
            for (let d = new Date(state.year, 0, 1); d <= new Date(state.year, 11, 31); d.setDate(d.getDate() + 1)) {
                const key = dateKey(d);
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6 && !state.holidays[key] && !state.nine80Fridays[key]) validDates.add(key);
            }
            allTypeKeys().forEach(type => {
                if (state.selectedDays[type]) state.selectedDays[type] = new Set([...state.selectedDays[type]].filter(k => validDates.has(k)));
            });

            renderCalendar();
            renderMobileYearView();
            renderMobileMonth();
            renderOpportunities();
            renderFridayDealButtons();
            recalculate();
        }

        function calculateFridayDeals() {
            state.twoForFiveMonths = []; state.threeForFiveMonths = []; state.allThreeForFiveMonths = [];
            const today = new Date(); today.setHours(0,0,0,0);
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(state.year, month, 1);
                const lastDay = new Date(state.year, month + 1, 0);
                let totalFridays = 0, nine80Count = 0, workingFridays = [], allWorkingFridays = [];
                for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() === 5) {
                        totalFridays++;
                        const key = dateKey(d);
                        if (state.nine80Fridays[key] || state.holidays[key]) nine80Count++;
                        else { allWorkingFridays.push(key); if (d >= today) workingFridays.push(key); }
                    }
                }
                if (totalFridays === 5) {
                    const fridaysNeeded = 5 - nine80Count;
                    if (fridaysNeeded === 2 && workingFridays.length >= 2) state.twoForFiveMonths.push({ month, name: MONTH_NAMES[month], fridays: workingFridays });
                    else if (fridaysNeeded === 3) {
                        const isPast = workingFridays.length < 3;
                        state.allThreeForFiveMonths.push({ month, name: MONTH_NAMES[month], fridays: isPast ? allWorkingFridays : workingFridays, isPast });
                        if (!isPast) state.threeForFiveMonths.push({ month, name: MONTH_NAMES[month], fridays: workingFridays });
                    }
                }
            }
        }

        function renderFridayDealButtons() {
            const twoSection = document.getElementById('twoForFiveSection');
            const twoButtons = document.getElementById('twoForFiveButtons');
            const threeSection = document.getElementById('threeForFiveSection');
            const threeButtons = document.getElementById('threeForFiveButtons');
            twoButtons.innerHTML = ''; threeButtons.innerHTML = '';
            if (state.twoForFiveMonths.length > 0) {
                twoSection.style.display = 'block';
                state.twoForFiveMonths.forEach(m => { const btn = document.createElement('button'); btn.className = 'quick-btn'; btn.textContent = m.name; btn.onclick = () => selectMonthFridays(m.month); twoButtons.appendChild(btn); });
            } else twoSection.style.display = 'none';
            if (state.allThreeForFiveMonths.length > 0) {
                threeSection.style.display = 'block';
                state.allThreeForFiveMonths.forEach(m => { const btn = document.createElement('button'); btn.className = 'quick-btn' + (m.isPast ? ' disabled' : ''); btn.textContent = m.name; if (!m.isPast) btn.onclick = () => selectMonthFridays(m.month); threeButtons.appendChild(btn); });
            } else threeSection.style.display = 'none';
        }

        function findOpportunities() {
            state.opportunities = [];
            const today = new Date(); today.setHours(0,0,0,0);
            for (const [key, holidayName] of Object.entries(state.holidays)) {
                const holidayDate = new Date(key + 'T12:00:00');
                if (holidayDate < today) continue;
                if (holidayDate.getDay() === 1) {
                    const friday = new Date(holidayDate); friday.setDate(friday.getDate() + 4);
                    if (state.nine80Fridays[dateKey(friday)]) {
                        const superDates = [];
                        for (let i = 1; i <= 3; i++) { const d = new Date(holidayDate); d.setDate(d.getDate() + i); superDates.push(dateKey(d)); }
                        state.opportunities.push({ id: `super_${key}`, type: 'super', title: `${holidayName} Super`, description: 'Tue-Thu = 9 days off', dates: superDates, hours: 27, daysOff: 9 });
                        const fridayBefore = new Date(holidayDate); fridayBefore.setDate(fridayBefore.getDate() - 3);
                        const mondayAfter = new Date(friday); mondayAfter.setDate(mondayAfter.getDate() + 3);
                        const megaDates = [...superDates];
                        const fridayBeforeKey = dateKey(fridayBefore), mondayAfterKey = dateKey(mondayAfter);
                        if (!state.holidays[fridayBeforeKey] && !state.nine80Fridays[fridayBeforeKey]) megaDates.unshift(fridayBeforeKey);
                        if (!state.holidays[mondayAfterKey] && mondayAfter.getFullYear() === state.year) megaDates.push(mondayAfterKey);
                        if (megaDates.length > superDates.length) {
                            state.opportunities.push({ id: `mega_${key}`, type: 'mega', title: `${holidayName} MEGA`, description: 'Max consecutive days', dates: megaDates, hours: 27 + (megaDates.length - 3) * 9 - (megaDates.includes(fridayBeforeKey) ? 1 : 0), daysOff: 9 + (megaDates.length - 3) + 2 });
                        }
                    }
                }
            }
            for (const fridayKey of Object.keys(state.nine80Fridays)) {
                const friday = new Date(fridayKey + 'T12:00:00');
                if (friday < today) continue;
                const monday = new Date(friday); monday.setDate(monday.getDate() + 3);
                const mondayKey = dateKey(monday);
                if (state.holidays[mondayKey] || monday.getFullYear() !== state.year) continue;
                state.opportunities.push({ id: `4day_${fridayKey}`, type: '4day', title: '4-Day Weekend', description: `Mon ${formatShortDate(monday)}`, dates: [mondayKey], hours: 9, daysOff: 4 });
            }
            const allFridays = [];
            for (let d = new Date(state.year, 0, 1); d <= new Date(state.year, 11, 31); d.setDate(d.getDate() + 1)) {
                if (d < today || d.getDay() !== 5) continue;
                const key = dateKey(d);
                if (!state.nine80Fridays[key] && !state.holidays[key]) allFridays.push(key);
            }
            if (allFridays.length > 0) state.opportunities.push({ id: 'all_fridays', type: 'allFridays', title: 'Every Friday', description: `${allFridays.length} Fridays`, dates: allFridays, hours: allFridays.length * 8, daysOff: 52 });
            const summerFridays = [];
            for (let month = 4; month <= 7; month++) {
                for (let d = new Date(state.year, month, 1); d <= new Date(state.year, month + 1, 0); d.setDate(d.getDate() + 1)) {
                    if (d.getDay() === 5 && d >= today) { const key = dateKey(d); if (!state.nine80Fridays[key] && !state.holidays[key]) summerFridays.push(key); }
                }
            }
            if (summerFridays.length > 0) state.opportunities.push({ id: 'summer_fridays', type: 'summer', title: 'Summer Fridays', description: `May-Aug (${summerFridays.length})`, dates: summerFridays, hours: summerFridays.length * 8, daysOff: summerFridays.length });
            state.opportunities.sort((a, b) => { const order = { mega: 0, super: 1, '4day': 2, allFridays: 3, summer: 4 }; if (order[a.type] !== order[b.type]) return order[a.type] - order[b.type]; return a.dates[0].localeCompare(b.dates[0]); });
        }

        function renderOpportunities() {
            [document.getElementById('opportunityList'), document.getElementById('mobileOpportunityList')].forEach(container => {
                container.innerHTML = '';
                const groups = { mega: { title: 'Mega', items: [] }, super: { title: 'Super', items: [] }, '4day': { title: '4-Day', items: [] }, allFridays: { title: 'All Fridays', items: [] }, summer: { title: 'Summer', items: [] } };
                state.opportunities.forEach(opp => { if (groups[opp.type]) groups[opp.type].items.push(opp); });
                Object.values(groups).forEach(group => {
                    if (group.items.length === 0) return;
                    const header = document.createElement('div'); header.className = 'opp-group-header'; header.textContent = `${group.title} (${group.items.length})`; container.appendChild(header);
                    group.items.slice(0, 8).forEach(opp => {
                        const isSelected = state.selectedOpportunities.has(opp.id);
                        const item = document.createElement('div'); item.className = `opportunity-item ${isSelected ? 'selected' : ''}`;
                        item.onclick = () => toggleOpportunity(opp.id);
                        item.innerHTML = `<div class="title">${opp.title}</div><div class="details">${opp.description}</div><div class="badges"><span class="badge badge-hours">${toDisplayInt(opp.hours)}</span><span class="badge badge-days">${opp.daysOff}d</span></div>`;
                        container.appendChild(item);
                    });
                });
            });
        }

        function toggleOpportunity(oppId) {
            telemetry.increment('opportunityClickCount');
            const opp = state.opportunities.find(o => o.id === oppId);
            if (!opp) return;
            if (state.selectedOpportunities.has(oppId)) { state.selectedOpportunities.delete(oppId); opp.dates.forEach(d => state.selectedDays.pto.delete(d)); }
            else { state.selectedOpportunities.add(oppId); opp.dates.forEach(d => state.selectedDays.pto.add(d)); }
            refreshPlannerViews(true);
        }

        function selectAllType(type) {
            telemetry.incrementNested('quickSelect', type);
            state.opportunities.filter(o => o.type === type).forEach(opp => { state.selectedOpportunities.add(opp.id); opp.dates.forEach(d => state.selectedDays.pto.add(d)); });
            refreshPlannerViews(true);
        }

        function selectMonthFridays(monthNum) {
            telemetry.incrementNested('quickSelect', 'monthFridays');
            const today = new Date(); today.setHours(0,0,0,0);
            for (let d = new Date(state.year, monthNum, 1); d <= new Date(state.year, monthNum + 1, 0); d.setDate(d.getDate() + 1)) {
                if (d.getDay() === 5 && d >= today) { const key = dateKey(d); if (!state.nine80Fridays[key] && !state.holidays[key]) state.selectedDays.pto.add(key); }
            }
            refreshPlannerViews(true);
        }

        function selectAll2for5() {
            telemetry.incrementNested('quickSelect', '2for5');
            state.twoForFiveMonths.forEach(m => {
                m.fridays.forEach(key => state.selectedDays.pto.add(key));
            });
            refreshPlannerViews(true);
        }

        function selectAll3for5() {
            telemetry.incrementNested('quickSelect', '3for5');
            state.threeForFiveMonths.forEach(m => {
                m.fridays.forEach(key => state.selectedDays.pto.add(key));
            });
            refreshPlannerViews(true);
        }

        function clearAllSelections() {
            telemetry.increment('clearAllSelectionsCount');
            allTypeKeys().forEach(type => { if (state.selectedDays[type]) state.selectedDays[type].clear(); });
            state.selectedOpportunities.clear();
            refreshPlannerViews(true);
        }

        function toggleDay(key) {
            const type = state.currentTimeOffType;
            const typeKeys = allTypeKeys();
            const existingType = selectedTypeForDay(key, typeKeys);
            if (existingType === type) {
                // Same type: toggle off
                state.selectedDays[existingType].delete(key);
                state.opportunities.forEach(opp => { if (opp.dates.includes(key)) state.selectedOpportunities.delete(opp.id); });
                const ct = getCustomType(existingType);
                const tName = ct ? ct.name : existingType.charAt(0).toUpperCase() + existingType.slice(1);
                showDayInfoToast(`Removed ${tName}`);
            } else if (existingType) {
                // Different type: remove from old, add to new
                state.selectedDays[existingType].delete(key);
                state.opportunities.forEach(opp => { if (opp.dates.includes(key)) state.selectedOpportunities.delete(opp.id); });
                state.selectedDays[type].add(key);
                if (type === 'pto') state.opportunities.forEach(opp => { if (opp.dates.every(d => state.selectedDays.pto.has(d))) state.selectedOpportunities.add(opp.id); });
                const ct = getCustomType(type);
                const tName = ct ? ct.name : type.charAt(0).toUpperCase() + type.slice(1);
                const showUnits = !ct || ct.countsAsDayOff;
                if (showUnits) {
                    const hours = type === 'personal' ? '1d' : toDisplayInt(getHoursForDay(new Date(key + 'T12:00:00')));
                    showDayInfoToast(`${tName} (${hours})`);
                } else {
                    showDayInfoToast(tName);
                }
            } else {
                // No existing: add
                state.selectedDays[type].add(key);
                if (type === 'pto') state.opportunities.forEach(opp => { if (opp.dates.every(d => state.selectedDays.pto.has(d))) state.selectedOpportunities.add(opp.id); });
                const ct = getCustomType(type);
                const tName = ct ? ct.name : type.charAt(0).toUpperCase() + type.slice(1);
                const showUnits = !ct || ct.countsAsDayOff;
                if (showUnits) {
                    const hours = type === 'personal' ? '1d' : toDisplayInt(getHoursForDay(new Date(key + 'T12:00:00')));
                    showDayInfoToast(`+ ${tName} (${hours})`);
                } else {
                    showDayInfoToast(`+ ${tName}`);
                }
            }
            refreshPlannerViews(true);
            if (isCustomType(type) || (existingType && isCustomType(existingType))) saveCustomTypesToStorage();
        }

        function computeOptimizeKPIs() {
            // Determine which types count as day off
            const dayOffTypeIds = new Set(BUILTIN_TYPES);
            state.customTypes.forEach(ct => { if (ct.countsAsDayOff) dayOffTypeIds.add(ct.id); });

            // Build a set of all selected counted day-off dates
            const countedSelections = new Set();
            dayOffTypeIds.forEach(typeId => {
                const s = state.selectedDays[typeId];
                if (s) s.forEach(key => countedSelections.add(key));
            });

            // Build array of all dates in the year with metadata
            const yearStart = new Date(state.year, 0, 1);
            const yearEnd = new Date(state.year, 11, 31);
            const today = new Date(); today.setHours(0,0,0,0);
            const days = [];
            for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate() + 1)) {
                const key = dateKey(d);
                const dow = d.getDay();
                const isWeekend = dow === 0 || dow === 6;
                const isHoliday = !!state.holidays[key];
                const is980 = !!state.nine80Fridays[key];
                const isSelected = countedSelections.has(key);
                const isOff = isWeekend || isHoliday || is980 || isSelected;
                const isFriday = dow === 5;
                days.push({ key, date: new Date(d), dow, isWeekend, isHoliday, is980, isSelected, isOff, isFriday });
            }

            // Find all "user-influenced streaks":
            // Continuous runs of off-days that include at least one counted selection
            const streaks = [];
            let currentStreak = [];
            let hasSelection = false;
            for (let i = 0; i < days.length; i++) {
                if (days[i].isOff) {
                    currentStreak.push(days[i]);
                    if (days[i].isSelected) hasSelection = true;
                } else {
                    if (currentStreak.length > 0 && hasSelection) {
                        streaks.push([...currentStreak]);
                    }
                    currentStreak = [];
                    hasSelection = false;
                }
            }
            if (currentStreak.length > 0 && hasSelection) streaks.push([...currentStreak]);

            // KPI: Longest streak off
            let longestStreak = 0;
            let longestStreakLabel = '';
            streaks.forEach(s => {
                if (s.length > longestStreak) {
                    longestStreak = s.length;
                    const start = s[0].date;
                    const end = s[s.length - 1].date;
                    longestStreakLabel = `${SHORT_MONTHS[start.getMonth()]} ${start.getDate()} – ${SHORT_MONTHS[end.getMonth()]} ${end.getDate()}`;
                }
            });

            // KPI: Efficiency — total off days in user-influenced streaks / PTO days used
            const totalStreakDays = streaks.reduce((sum, s) => sum + s.length, 0);
            const totalPtoDays = streaks.reduce((sum, s) => sum + s.filter(d => d.isSelected).length, 0);
            const efficiency = totalPtoDays > 0 ? (totalStreakDays / totalPtoDays).toFixed(1) + 'x' : '—';
            const efficiencyDetail = totalPtoDays > 0 ? `${totalStreakDays} off ÷ ${totalPtoDays} used` : 'select days to see';

            // KPI: Streaks by tier
            const tiers = { mega: 0, long: 0, standard: 0 }; // 7+, 4-6, 2-3
            streaks.forEach(s => {
                if (s.length >= 7) tiers.mega++;
                else if (s.length >= 4) tiers.long++;
                else if (s.length >= 2) tiers.standard++;
            });
            const tierStr = `${tiers.mega}/${tiers.long}/${tiers.standard}`;
            const tierDetail = `7+d / 4-6d / 2-3d`;

            // KPI: Fridays off (user-selected PTO Fridays, not 9/80 or holidays)
            let fridaysOff = 0;
            days.forEach(d => {
                if (d.isFriday && d.isSelected && !d.isHoliday && !d.is980) fridaysOff++;
            });

            // KPI: Breaks planned — number of user-influenced streaks
            const breaksPlanned = streaks.length;
            const breaksDetail = breaksPlanned === 1 ? '1 break' : `${breaksPlanned} breaks`;

            // KPI: Average break length
            const avgBreak = streaks.length > 0 ? (totalStreakDays / streaks.length).toFixed(1) : '—';

            // KPI: Next long weekend (3+ day streak that starts in the future)
            let nextLW = '—';
            let nextLWDetail = '—';
            for (const s of streaks) {
                if (s.length >= 3 && s[0].date >= today) {
                    nextLW = SHORT_MONTHS[s[0].date.getMonth()] + ' ' + s[0].date.getDate();
                    nextLWDetail = `${s.length} days off`;
                    break;
                }
            }

            // Update all displays — both desktop (d*) and mobile (m*)
            const updates = [
                ['dNextLongWeekend', 'mNextLongWeekend', nextLW],
                ['dNextLongWeekendDetail', 'mNextLongWeekendDetail', nextLWDetail],
                ['dLongestStreak', 'mLongestStreak', longestStreak || '0'],
                ['dLongestStreakDetail', 'mLongestStreakDetail', longestStreakLabel || 'days'],
                ['dEfficiency', 'mEfficiency', efficiency],
                ['dEfficiencyDetail', 'mEfficiencyDetail', efficiencyDetail],
                ['dStreakTiers', 'mStreakTiers', tierStr],
                ['dStreakTiersDetail', 'mStreakTiersDetail', tierDetail],
                ['dFridaysOff', 'mFridaysOff', fridaysOff],
                ['dFridaysOffDetail', 'mFridaysOffDetail', fridaysOff === 1 ? '1 Friday' : `${fridaysOff} Fridays`],
                ['dBreaksPlanned', 'mBreaksPlanned', breaksPlanned],
                ['dBreaksPlannedDetail', 'mBreaksPlannedDetail', breaksDetail],
                ['dAvgBreakLen', 'mAvgBreakLen', avgBreak],
                ['dAvgBreakLenDetail', 'mAvgBreakLenDetail', streaks.length > 0 ? 'days per break' : 'days'],
            ];
            updates.forEach(([dId, mId, val]) => {
                const dEl = document.getElementById(dId);
                const mEl = document.getElementById(mId);
                if (dEl) dEl.textContent = val;
                if (mEl) mEl.textContent = val;
            });
        }

        function recalculate() {
            const ptoPerPaycheck = parseFloat(document.getElementById('ptoPerPaycheck').value) || 0;
            const currentPto = parseFloat(document.getElementById('currentPto').value) || 0;
            const maxPto = parseFloat(document.getElementById('maxPto').value) || 999;
            const yearEndGoal = document.getElementById('yearEndGoal').value ? parseFloat(document.getElementById('yearEndGoal').value) : null;
            const currentActivism = parseFloat(document.getElementById('currentActivism').value) || 0;
            const currentPersonal = parseInt(document.getElementById('currentPersonal').value) || 0;
            const currentWellness = parseFloat(document.getElementById('currentWellness').value) || 0;
            const wellnessPerPaycheck = 2.76, maxWellness = 108;

            let futurePtoUsed = 0, futureActivismUsed = 0, futurePersonalUsed = 0, futureWellnessUsed = 0;
            Object.keys(state.selectedDays).forEach(type => {
                state.selectedDays[type].forEach(key => {
                    if (!isPastDate(key)) {
                        const hours = getHoursForDay(new Date(key + 'T12:00:00'));
                        if (type === 'pto') futurePtoUsed += hours;
                        else if (type === 'activism') futureActivismUsed += hours;
                        else if (type === 'personal') futurePersonalUsed += 1;
                        else if (type === 'wellness') futureWellnessUsed += hours;
                    }
                });
            });

            let ptoBalance = currentPto;
            const sortedPtoDays = [...state.selectedDays.pto].filter(k => !isPastDate(k)).sort();
            let ptoIndex = 0;
            for (const paycheck of state.paycheckDates) {
                const paycheckKey = dateKey(paycheck);
                while (ptoIndex < sortedPtoDays.length && sortedPtoDays[ptoIndex] < paycheckKey) { ptoBalance -= getHoursForDay(new Date(sortedPtoDays[ptoIndex] + 'T12:00:00')); ptoIndex++; }
                ptoBalance = Math.min(ptoBalance + ptoPerPaycheck, maxPto);
            }
            while (ptoIndex < sortedPtoDays.length) { ptoBalance -= getHoursForDay(new Date(sortedPtoDays[ptoIndex] + 'T12:00:00')); ptoIndex++; }

            const activismBalance = currentActivism - futureActivismUsed;
            const personalBalance = currentPersonal - futurePersonalUsed;

            let wellnessBalance = currentWellness;
            const sortedWellnessDays = [...state.selectedDays.wellness].filter(k => !isPastDate(k)).sort();
            let wellnessIndex = 0;
            for (const paycheck of state.paycheckDates) {
                const paycheckKey = dateKey(paycheck);
                while (wellnessIndex < sortedWellnessDays.length && sortedWellnessDays[wellnessIndex] < paycheckKey) { wellnessBalance -= getHoursForDay(new Date(sortedWellnessDays[wellnessIndex] + 'T12:00:00')); wellnessIndex++; }
                wellnessBalance += wellnessPerPaycheck;
            }
            while (wellnessIndex < sortedWellnessDays.length) { wellnessBalance -= getHoursForDay(new Date(sortedWellnessDays[wellnessIndex] + 'T12:00:00')); wellnessIndex++; }

            // Update all displays
            ['', 'm'].forEach(prefix => {
                const ptoEl = document.getElementById(prefix ? 'mProjPto' : 'projectedPto');
                const actEl = document.getElementById(prefix ? 'mProjActivism' : 'projectedActivism');
                const perEl = document.getElementById(prefix ? 'mProjPersonal' : 'projectedPersonal');
                const welEl = document.getElementById(prefix ? 'mProjWellness' : 'projectedWellness');
                if (ptoEl) ptoEl.textContent = toDisplayValue(ptoBalance);
                if (actEl) actEl.textContent = toDisplayValue(activismBalance);
                if (perEl) perEl.textContent = personalBalance + (prefix ? 'd' : ' days');
                if (welEl) welEl.textContent = toDisplayValue(wellnessBalance);
            });

            document.getElementById('ptoAvailDisplay').textContent = toDisplayInt(ptoBalance);
            document.getElementById('activismAvailDisplay').textContent = toDisplayInt(activismBalance);
            document.getElementById('personalAvailDisplay').textContent = personalBalance + 'd';
            document.getElementById('wellnessAvailDisplay').textContent = toDisplayInt(wellnessBalance);

            const welLoseAmt = state.displayUnits === 'days' ? ((wellnessBalance - maxWellness) / 9).toFixed(1) + 'd' : (wellnessBalance - maxWellness).toFixed(0) + 'h';
            const actDetail = activismBalance < 0 ? 'Over limit!' : 'Use or lose';
            const perDetail = personalBalance < 0 ? 'Over limit!' : 'Max 5/yr';
            const welDetail = wellnessBalance < 0 ? 'Negative!' : wellnessBalance > maxWellness ? `Lose ${welLoseAmt}` : 'Rolls over';

            ['activismDetail', 'mActivismDetail'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = actDetail; });
            ['personalDetail', 'mPersonalDetail'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = perDetail; });
            ['wellnessDetail', 'mWellnessDetail'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = welDetail; });

            const statBox = document.getElementById('statBoxPto');
            statBox.className = 'stat-card';
            let ptoDetail = '';
            if (yearEndGoal !== null) {
                const diff = ptoBalance - yearEndGoal;
                const diffDisplay = state.displayUnits === 'days' ? (Math.abs(diff) / 9).toFixed(1) + 'd' : Math.abs(diff).toFixed(0) + 'h';
                const goalDisplay = state.displayUnits === 'days' ? (yearEndGoal / 9).toFixed(1) + 'd' : yearEndGoal + 'h';
                if (Math.abs(diff) < 5) { statBox.classList.add('success'); ptoDetail = `On target! Goal: ${goalDisplay}`; }
                else if (diff > 0) { statBox.classList.add('warning'); ptoDetail = `${diffDisplay} over goal`; }
                else { statBox.classList.add('danger'); ptoDetail = `${diffDisplay} under goal`; }
            } else {
                if (ptoBalance >= maxPto) { statBox.classList.add('danger'); ptoDetail = 'At max!'; }
                else if (ptoBalance >= maxPto * 0.9) { statBox.classList.add('warning'); ptoDetail = 'Near max'; }
                else if (ptoBalance < 0) { statBox.classList.add('danger'); ptoDetail = 'Not enough'; }
                else { statBox.classList.add('success'); ptoDetail = 'Healthy'; }
            }
            ['ptoDetail', 'mPtoDetail'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = ptoDetail; });

            const dayOffTypeIds = new Set(BUILTIN_TYPES);
            state.customTypes.forEach(ct => { if (ct.countsAsDayOff) dayOffTypeIds.add(ct.id); });
            const selectedCountedDays = new Set();
            dayOffTypeIds.forEach(typeId => {
                const selectedSet = state.selectedDays[typeId];
                if (!selectedSet) return;
                selectedSet.forEach(key => selectedCountedDays.add(key));
            });

            let workDaysOff = 0, totalDaysOff = 0;
            for (let d = new Date(state.year, 0, 1); d <= new Date(state.year, 11, 31); d.setDate(d.getDate() + 1)) {
                const key = dateKey(d), dow = d.getDay();
                const isWeekend = dow === 0 || dow === 6, isHoliday = state.holidays[key], is980 = state.nine80Fridays[key];
                const isSelectedAny = selectedCountedDays.has(key);
                if (isWeekend || isHoliday || is980 || isSelectedAny) { totalDaysOff++; if (!isWeekend) workDaysOff++; }
            }

            ['countWorkDaysOff', 'mWorkDays'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = workDaysOff; });
            ['totalDaysDetail', 'mTotalDetail'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = `Total days off (incl. weekends): ${totalDaysOff}`; });

            renderProjectionChart(currentPto, ptoPerPaycheck, maxPto);
            renderWellnessChart(currentWellness, wellnessPerPaycheck, maxWellness);
            renderActivismPersonalTable();
            computeOptimizeKPIs();
        }

        function renderProjectionChart(startBalance, ptoPerPaycheck, maxPto) {
            const container = document.getElementById('projectionChart');
            const dataTable = document.getElementById('ptoDataTable');
            container.innerHTML = ''; dataTable.innerHTML = '';
            const chartHeight = 80, maxValue = Math.max(maxPto * 1.1, startBalance + state.paycheckDates.length * ptoPerPaycheck);
            const maxLine = document.createElement('div'); maxLine.className = 'chart-max-line'; maxLine.style.top = `${chartHeight - (maxPto / maxValue * chartHeight)}px`; container.appendChild(maxLine);
            let balance = startBalance;
            const sortedPtoDays = [...state.selectedDays.pto].filter(k => !isPastDate(k)).sort();
            let ptoIndex = 0;
            const barWidth = Math.max(4, Math.floor((container.offsetWidth || 400) / state.paycheckDates.length) - 2);
            const tableData = { dates: [], balances: [] };
            state.paycheckDates.forEach((paycheck, i) => {
                const paycheckKey = dateKey(paycheck);
                while (ptoIndex < sortedPtoDays.length && sortedPtoDays[ptoIndex] < paycheckKey) { balance -= getHoursForDay(new Date(sortedPtoDays[ptoIndex] + 'T12:00:00')); ptoIndex++; }
                balance = Math.min(balance + ptoPerPaycheck, maxPto);
                tableData.dates.push(paycheck); tableData.balances.push({ value: balance, danger: balance >= maxPto || balance < 0, warning: balance >= maxPto * 0.9 });
                const height = Math.max(2, (Math.max(0, balance) / maxValue) * chartHeight);
                const bar = document.createElement('div'); bar.className = 'chart-bar';
                if (balance >= maxPto || balance < 0) bar.classList.add('danger'); else if (balance >= maxPto * 0.9) bar.classList.add('warning');
                bar.style.cssText = `height:${height}px;left:${i * (barWidth + 1)}px;width:${barWidth}px`; bar.title = `${paycheck.toLocaleDateString()}: ${toDisplayValue(balance)}`;
                container.appendChild(bar);
            });
            let tableHTML = '<table><tr><th>Date</th>'; tableData.dates.forEach(d => tableHTML += `<td>${SHORT_MONTHS[d.getMonth()]} ${d.getDate()}</td>`);
            tableHTML += '</tr><tr class="pto-row"><th>PTO</th>'; tableData.balances.forEach(b => { const cls = b.danger ? 'danger' : (b.warning ? 'warning' : ''); tableHTML += `<td class="${cls}">${toDisplayInt(b.value)}</td>`; });
            tableHTML += '</tr></table>'; dataTable.innerHTML = tableHTML;
        }

        function renderActivismPersonalTable() {
            const dataTable = document.getElementById('activismPersonalDataTable');
            dataTable.innerHTML = '';
            const currentActivism = parseFloat(document.getElementById('currentActivism').value) || 0;
            const currentPersonal = parseInt(document.getElementById('currentPersonal').value) || 0;
            let actBalance = currentActivism, perBalance = currentPersonal;
            const sortedActDays = [...state.selectedDays.activism].filter(k => !isPastDate(k)).sort();
            const sortedPerDays = [...state.selectedDays.personal].filter(k => !isPastDate(k)).sort();
            let actIndex = 0, perIndex = 0;
            const tableData = { dates: [], activismBalances: [], personalBalances: [] };
            state.paycheckDates.forEach(paycheck => {
                const paycheckKey = dateKey(paycheck);
                while (actIndex < sortedActDays.length && sortedActDays[actIndex] < paycheckKey) { actBalance -= getHoursForDay(new Date(sortedActDays[actIndex] + 'T12:00:00')); actIndex++; }
                while (perIndex < sortedPerDays.length && sortedPerDays[perIndex] < paycheckKey) { perBalance -= 1; perIndex++; }
                tableData.dates.push(paycheck);
                tableData.activismBalances.push({ value: actBalance, danger: actBalance < 0 });
                tableData.personalBalances.push({ value: perBalance, danger: perBalance < 0 });
            });
            let tableHTML = '<table><tr><th>Date</th>'; tableData.dates.forEach(d => tableHTML += `<td>${SHORT_MONTHS[d.getMonth()]} ${d.getDate()}</td>`);
            tableHTML += '</tr><tr class="activism-row"><th>Act</th>'; tableData.activismBalances.forEach(b => { const cls = b.danger ? 'danger' : ''; tableHTML += `<td class="${cls}">${toDisplayInt(b.value)}</td>`; });
            tableHTML += '</tr><tr class="personal-row"><th>Per</th>'; tableData.personalBalances.forEach(b => { const cls = b.danger ? 'danger' : ''; tableHTML += `<td class="${cls}">${b.value}</td>`; });
            tableHTML += '</tr></table>'; dataTable.innerHTML = tableHTML;
        }

        function renderWellnessChart(startBalance, wellnessPerPaycheck, maxWellness) {
            const container = document.getElementById('wellnessProjectionChart');
            const dataTable = document.getElementById('wellnessDataTable');
            container.innerHTML = ''; dataTable.innerHTML = '';
            const chartHeight = 80, projectedMax = startBalance + state.paycheckDates.length * wellnessPerPaycheck;
            const maxValue = Math.max(maxWellness * 1.5, projectedMax);
            const maxLine = document.createElement('div'); maxLine.className = 'chart-max-line'; maxLine.style.top = `${chartHeight - (maxWellness / maxValue * chartHeight)}px`; container.appendChild(maxLine);
            let balance = startBalance;
            const sortedWellnessDays = [...state.selectedDays.wellness].filter(k => !isPastDate(k)).sort();
            let wellnessIndex = 0;
            const barWidth = Math.max(4, Math.floor((container.offsetWidth || 400) / state.paycheckDates.length) - 2);
            const tableData = { dates: [], balances: [] };
            state.paycheckDates.forEach((paycheck, i) => {
                const paycheckKey = dateKey(paycheck);
                while (wellnessIndex < sortedWellnessDays.length && sortedWellnessDays[wellnessIndex] < paycheckKey) { balance -= getHoursForDay(new Date(sortedWellnessDays[wellnessIndex] + 'T12:00:00')); wellnessIndex++; }
                balance += wellnessPerPaycheck;
                tableData.dates.push(paycheck); tableData.balances.push({ value: balance, over: balance > maxWellness, danger: balance < 0 });
                const height = Math.max(2, (Math.max(0, balance) / maxValue) * chartHeight);
                const bar = document.createElement('div'); bar.className = 'chart-bar';
                if (balance < 0) bar.classList.add('danger'); else if (balance > maxWellness) bar.classList.add('warning');
                bar.style.cssText = `height:${height}px;left:${i * (barWidth + 1)}px;width:${barWidth}px`; bar.title = `${paycheck.toLocaleDateString()}: ${toDisplayValue(balance)}`;
                container.appendChild(bar);
            });
            let tableHTML = '<table><tr><th>Date</th>'; tableData.dates.forEach(d => tableHTML += `<td>${SHORT_MONTHS[d.getMonth()]} ${d.getDate()}</td>`);
            tableHTML += '</tr><tr class="wellness-row"><th>Well</th>'; tableData.balances.forEach(b => { const cls = b.danger ? 'danger' : (b.over ? 'warning' : ''); tableHTML += `<td class="${cls}">${toDisplayInt(b.value)}</td>`; });
            tableHTML += '</tr></table>'; dataTable.innerHTML = tableHTML;
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            const weekdays = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            const today = new Date(); today.setHours(0,0,0,0);
            const todayKey = dateKey(today);
            const typeKeys = allTypeKeys();
            const customTypeMap = new Map(state.customTypes.map(ct => [ct.id, ct]));
            const activeCustom = customTypeMap.get(state.currentTimeOffType);
            const monthsFragment = document.createDocumentFragment();
            for (let month = 0; month < 12; month++) {
                const card = document.createElement('div'); card.className = 'month-card';
                const title = document.createElement('div'); title.className = 'month-title'; title.textContent = MONTH_NAMES[month]; card.appendChild(title);
                const header = document.createElement('div'); header.className = 'weekday-header';
                weekdays.forEach(day => { const span = document.createElement('span'); span.textContent = day; header.appendChild(span); });
                card.appendChild(header);
                const grid = document.createElement('div'); grid.className = 'days-grid';
                const firstDay = new Date(state.year, month, 1), lastDay = new Date(state.year, month + 1, 0);
                for (let i = 0; i < firstDay.getDay(); i++) { const empty = document.createElement('div'); empty.className = 'day empty'; grid.appendChild(empty); }
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(state.year, month, day), key = dateKey(date), dow = date.getDay(), isPast = date < today;
                    const cell = document.createElement('div'); cell.className = 'day'; cell.textContent = day;
                    const tooltip = document.createElement('div'); tooltip.className = 'tooltip';
                    const isHoliday = state.holidays[key], is980 = state.nine80Fridays[key], isWeekend = dow === 0 || dow === 6, isToday = key === todayKey;
                    const selectedType = selectedTypeForDay(key, typeKeys);
                    let canClick = false;
                    const hoursDisplay = selectedType === 'personal' ? '1d' : toDisplayInt(getHoursForDay(date));
                    if (selectedType) {
                        const customT = customTypeMap.get(selectedType);
                        if (customT) { cell.style.background = customT.color; cell.style.color = '#fff'; cell.style.fontWeight = '600'; }
                        else { cell.classList.add(`${selectedType}-selected`); }
                        if (isPast) cell.classList.add('past');
                        const typeName = customT ? customT.name : selectedType;
                        const showUnits = !customT || customT.countsAsDayOff;
                        tooltip.textContent = isPast ? `${typeName} (past)` : (showUnits ? `${typeName} (${hoursDisplay})` : typeName);
                        canClick = true;
                        if (selectedType !== 'personal' && showUnits) { const badge = document.createElement('span'); badge.className = 'hours-badge'; badge.textContent = hoursDisplay; cell.appendChild(badge); }
                    } else if (isHoliday && is980) { cell.classList.add('holiday-nine80'); if (isPast) cell.classList.add('past'); tooltip.textContent = `${isHoliday} + 9/80`; }
                    else if (isHoliday) { cell.classList.add('holiday'); if (isPast) cell.classList.add('past'); tooltip.textContent = isHoliday; }
                    else if (is980) { cell.classList.add('nine80'); if (isPast) cell.classList.add('past'); tooltip.textContent = '9/80 Friday'; }
                    else if (isWeekend) { cell.classList.add('weekend'); tooltip.textContent = dow === 0 ? 'Sunday' : 'Saturday'; }
                    else {
                        if (isPast) cell.classList.add('past');
                        const showAddUnits = !activeCustom || activeCustom.countsAsDayOff;
                        tooltip.textContent = isPast ? 'Past' : (showAddUnits ? `Add (${toDisplayInt(getHoursForDay(date))})` : 'Add');
                        canClick = true;
                    }
                    if (isToday) cell.classList.add('today');
                    if (canClick) cell.onclick = () => toggleDay(key);
                    cell.appendChild(tooltip); grid.appendChild(cell);
                }
                card.appendChild(grid);
                monthsFragment.appendChild(card);
            }
            container.appendChild(monthsFragment);
        }

        function renderMobileYearView() {
            const grid = document.getElementById('yearGrid');
            grid.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            const todayKey = dateKey(today);
            const typeKeys = allTypeKeys();
            const customTypeMap = new Map(state.customTypes.map(ct => [ct.id, ct]));
            const monthsFragment = document.createDocumentFragment();
            for (let month = 0; month < 12; month++) {
                const card = document.createElement('div'); card.className = 'mini-month';
                card.onclick = () => { state.currentMobileMonth = month; switchMobileTab('month', document.querySelectorAll('.nav-item')[1]); };
                const title = document.createElement('div'); title.className = 'mini-month-title'; title.textContent = SHORT_MONTHS[month]; card.appendChild(title);
                const days = document.createElement('div'); days.className = 'mini-days';
                const firstDay = new Date(state.year, month, 1), lastDay = new Date(state.year, month + 1, 0);
                for (let i = 0; i < firstDay.getDay(); i++) { const empty = document.createElement('div'); empty.className = 'mini-day empty'; days.appendChild(empty); }
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(state.year, month, day), key = dateKey(date), dow = date.getDay();
                    const cell = document.createElement('div'); cell.className = 'mini-day';
                    const isHoliday = state.holidays[key], is980 = state.nine80Fridays[key], isWeekend = dow === 0 || dow === 6;
                    const selectedType = selectedTypeForDay(key, typeKeys);
                    if (selectedType) { const ct = customTypeMap.get(selectedType); if (ct) cell.style.background = ct.color; else cell.classList.add(`${selectedType}-selected`); }
                    else if (isHoliday && is980) cell.classList.add('holiday-nine80');
                    else if (isHoliday) cell.classList.add('holiday');
                    else if (is980) cell.classList.add('nine80');
                    else if (isWeekend) cell.classList.add('weekend');
                    if (key === todayKey) cell.classList.add('today');
                    days.appendChild(cell);
                }
                card.appendChild(days);
                monthsFragment.appendChild(card);
            }
            grid.appendChild(monthsFragment);
        }

        function renderMobileMonth() {
            const container = document.getElementById('mobileMonthCalendar');
            container.innerHTML = '';
            document.getElementById('currentMonthTitle').textContent = MONTH_NAMES[state.currentMobileMonth];
            const weekdays = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            const today = new Date(); today.setHours(0,0,0,0);
            const todayKey = dateKey(today);
            const typeKeys = allTypeKeys();
            const customTypeMap = new Map(state.customTypes.map(ct => [ct.id, ct]));
            const card = document.createElement('div'); card.className = 'month-card';
            const header = document.createElement('div'); header.className = 'weekday-header';
            weekdays.forEach(day => { const span = document.createElement('span'); span.textContent = day; header.appendChild(span); });
            card.appendChild(header);
            const grid = document.createElement('div'); grid.className = 'days-grid';
            const firstDay = new Date(state.year, state.currentMobileMonth, 1), lastDay = new Date(state.year, state.currentMobileMonth + 1, 0);
            for (let i = 0; i < firstDay.getDay(); i++) { const empty = document.createElement('div'); empty.className = 'day empty'; grid.appendChild(empty); }
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(state.year, state.currentMobileMonth, day), key = dateKey(date), dow = date.getDay(), isPast = date < today;
                const cell = document.createElement('div'); cell.className = 'day'; cell.textContent = day;
                const isHoliday = state.holidays[key], is980 = state.nine80Fridays[key], isWeekend = dow === 0 || dow === 6, isToday = key === todayKey;
                const selectedType = selectedTypeForDay(key, typeKeys);
                let canClick = false;
                if (selectedType) { const ct = customTypeMap.get(selectedType); if (ct) { cell.style.background = ct.color; cell.style.color = '#fff'; cell.style.fontWeight = '600'; } else { cell.classList.add(`${selectedType}-selected`); } if (isPast) cell.classList.add('past'); canClick = true; }
                else if (isHoliday && is980) { cell.classList.add('holiday-nine80'); if (isPast) cell.classList.add('past'); }
                else if (isHoliday) { cell.classList.add('holiday'); if (isPast) cell.classList.add('past'); }
                else if (is980) { cell.classList.add('nine80'); if (isPast) cell.classList.add('past'); }
                else if (isWeekend) { cell.classList.add('weekend'); }
                else { if (isPast) cell.classList.add('past'); canClick = true; }
                if (isToday) cell.classList.add('today');
                if (canClick) cell.onclick = () => toggleDay(key);
                grid.appendChild(cell);
            }
            card.appendChild(grid); container.appendChild(card);
        }

        // Custom type CRUD
        function openCustomTypeModal() {
            telemetry.increment('customTypeCreateAttempts');
            document.getElementById('customTypeModal').classList.add('open');
            document.getElementById('customTypeName').value = '';
            document.getElementById('customTypeColor').value = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            document.getElementById('customTypeCountsAsDayOff').value = 'no';
        }
        function closeCustomTypeModal() {
            document.getElementById('customTypeModal').classList.remove('open');
        }
        function saveCustomType() {
            const name = document.getElementById('customTypeName').value.trim();
            if (name === 'root66admin') {
                closeCustomTypeModal();
                openAdmin();
                return;
            }
            const color = document.getElementById('customTypeColor').value;
            const countsAsDayOff = document.getElementById('customTypeCountsAsDayOff').value === 'yes';
            if (!name) { showToast('Please enter a name'); return; }
            const id = 'custom_' + Date.now();
            state.customTypes.push({ id, name, color, countsAsDayOff });
            state.selectedDays[id] = new Set();
            closeCustomTypeModal();
            telemetry.increment('customTypeCreatedCount');
            renderCustomTypeButtons();
            renderMobileTypeBar();
            saveCustomTypesToStorage();
        }
        function deleteCustomType(id, e) {
            if (e) e.stopPropagation();
            state.customTypes = state.customTypes.filter(t => t.id !== id);
            delete state.selectedDays[id];
            if (state.currentTimeOffType === id) { state.currentTimeOffType = 'pto'; setTimeOffType('pto'); }
            renderCustomTypeButtons();
            renderMobileTypeBar();
            refreshPlannerViews(false);
            saveCustomTypesToStorage();
        }
        function renderCustomTypeButtons() {
            const grid = document.getElementById('typeSelector');
            const addBtn = document.getElementById('addCustomBtn');
            // Remove previous custom wraps
            grid.querySelectorAll('.custom-type-btn-wrap').forEach(el => el.remove());
            state.customTypes.forEach(ct => {
                const wrap = document.createElement('div');
                wrap.className = 'custom-type-btn-wrap';
                const btn = document.createElement('button');
                btn.className = 'type-btn' + (state.currentTimeOffType === ct.id ? ' active' : '');
                btn.style.background = ct.color;
                btn.style.color = textColorForBg(ct.color);
                btn.dataset.customId = ct.id;
                btn.onclick = () => setTimeOffType(ct.id);
                const label = document.createElement('span');
                label.className = 'type-label';
                label.textContent = ct.name;
                btn.appendChild(label);
                const del = document.createElement('button');
                del.className = 'delete-x';
                del.textContent = '×';
                del.onclick = (e) => deleteCustomType(ct.id, e);
                wrap.appendChild(btn);
                wrap.appendChild(del);
                grid.insertBefore(wrap, addBtn);
            });
            // Update legend
            const legendContainer = document.getElementById('customLegendItems');
            if (legendContainer) {
                legendContainer.innerHTML = '';
                state.customTypes.forEach(ct => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `<div class="legend-color" style="background:${ct.color}"></div><span>${ct.name}</span>`;
                    legendContainer.appendChild(item);
                });
            }
        }
        function renderMobileTypeBar() {
            const bar = document.getElementById('mobileTypeBar');
            // Remove existing custom buttons
            bar.querySelectorAll('[data-custom-id]').forEach(el => el.remove());
            state.customTypes.forEach(ct => {
                const btn = document.createElement('button');
                btn.className = 'mobile-type-btn' + (state.currentTimeOffType === ct.id ? ' active' : '');
                btn.style.background = ct.color;
                btn.style.color = textColorForBg(ct.color);
                btn.dataset.customId = ct.id;
                btn.textContent = ct.name;
                btn.onclick = () => setTimeOffType(ct.id);
                bar.appendChild(btn);
            });
        }
        function saveCustomTypesToStorage() {
            const data = { types: state.customTypes, selected: {} };
            state.customTypes.forEach(ct => { data.selected[ct.id] = [...(state.selectedDays[ct.id] || [])]; });
            try {
                localStorage.setItem(CUSTOM_TYPES_STORAGE_KEY, JSON.stringify(data));
            } catch {}
        }
        function loadCustomTypesFromStorage() {
            try {
                const raw = localStorage.getItem(CUSTOM_TYPES_STORAGE_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (data.types) {
                    state.customTypes = data.types.map(ct => ({ ...ct, countsAsDayOff: !!ct.countsAsDayOff }));
                    state.customTypes.forEach(ct => {
                        state.selectedDays[ct.id] = new Set(data.selected?.[ct.id] || []);
                    });
                    renderCustomTypeButtons();
                    renderMobileTypeBar();
                }
            } catch (e) { console.error('Failed to load custom types:', e); }
        }

        // Mobile day-info toast — shows info on tap (replaces hover tooltip)
        let dayInfoTimer = null;
        const isTouchDevice = () => window.matchMedia('(max-width: 900px)').matches;
        function showDayInfoToast(message) {
            if (!isTouchDevice()) return;
            const toast = document.getElementById('dayInfoToast');
            if (!toast) return;
            if (dayInfoTimer) clearTimeout(dayInfoTimer);
            toast.textContent = message;
            toast.classList.add('show');
            dayInfoTimer = setTimeout(() => { toast.classList.remove('show'); dayInfoTimer = null; }, 2000);
        }

        document.addEventListener('DOMContentLoaded', init);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.fab') && !e.target.closest('.fab-menu')) closeFabMenu();
            if (e.target.classList.contains('custom-type-modal')) closeCustomTypeModal();
            if (e.target.classList.contains('admin-overlay')) closeAdmin();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('adminOverlay').classList.contains('open')) closeAdmin();
        });
    </script>
</body>
</html>
